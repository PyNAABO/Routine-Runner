<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Routine Runner</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0f172a" id="theme-color-meta" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="icon" href="assets/RR.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap");

      /* Base Variables */
      :root {
        --bg-body: #0f172a;
        --bg-card: rgba(30, 41, 59, 0.7);
        --text-main: #e2e8f0;
        --text-muted: #94a3b8;
        --border: rgba(255, 255, 255, 0.1);
        --accent: #059669; /* Emerald 600 */
        --glass: blur(16px);
      }

      /* Light Mode Overrides */
      .light-mode {
        --bg-body: #f1f5f9;
        --bg-card: rgba(255, 255, 255, 0.82);
        --text-main: #1f2937;
        --text-muted: #64748b;
        --border: rgba(0, 0, 0, 0.08); /* Softer border */
        --accent: #10b981; /* Emerald 500 */
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        overscroll-behavior-y: none;
        transition: background-color 0.3s ease, color 0.3s ease;
        background-attachment: fixed;
      }

      /* Dynamic Backgrounds */
      body:not(.light-mode) {
        background-image: radial-gradient(
          circle at 15% 50%,
          #1e293b 0%,
          #0f172a 80%
        );
      }
      .light-mode body {
        background-image: linear-gradient(135deg, #e0f2fe 0%, #f1f5f9 100%);
      }

      .bg-card-custom {
        background-color: var(--bg-card);
        backdrop-filter: var(--glass);
        -webkit-backdrop-filter: var(--glass);
      }
      /* Fixed Utility Classes */
      .bg-body {
        background-color: var(--bg-body);
      }
      .text-main {
        color: var(--text-main);
      }
      .text-muted-custom {
        color: var(--text-muted);
      }
      .border-custom {
        border-color: var(--border);
      }

      .mono {
        font-family: "JetBrains Mono", monospace;
      }
      .h-dvh {
        height: 100dvh;
      }
      .safe-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }
      .scroll-touch {
        -webkit-overflow-scrolling: touch;
      }

      /* Utils */
      .task-card {
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .priority-glow {
        box-shadow: 0 0 30px rgba(234, 179, 8, 0.15);
        border-color: #eab308 !important;
      }

      /* Toggle Switch */
      .toggle-checkbox:checked {
        right: 0;
        border-color: #10b981;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #10b981;
      }
    </style>
  </head>
  <body class="h-dvh w-screen overflow-hidden flex flex-col safe-bottom">
    <!-- SETUP SCREEN -->
    <div
      id="setup-screen"
      class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6 hidden"
    >
      <div class="w-full max-w-md">
        <h1 class="text-2xl font-bold text-white mb-2">⚙️ Connect Database</h1>
        <p class="text-slate-400 mb-4 text-sm">
          Paste your <strong>Firebase Config JSON</strong> OR a
          <strong>Raw Gist URL</strong>.
        </p>
        <textarea
          id="config-input"
          class="w-full bg-slate-800 text-emerald-400 font-mono text-xs p-4 rounded-xl h-32 mb-4 focus:outline-none focus:ring-2 focus:ring-emerald-500 border border-slate-700 placeholder-slate-600"
        ></textarea>
        <button
          id="save-config-btn"
          class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold shadow-lg transition flex justify-center items-center gap-2"
        >
          <span>Save & Connect</span>
        </button>
        <p
          id="setup-error"
          class="text-red-400 text-xs mt-3 text-center hidden"
        ></p>
      </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div
      id="login-screen"
      class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6 hidden"
    >
      <div class="mb-6 flex flex-col items-center">
        <img
          src="assets/RR.png"
          class="h-24 w-24 object-contain mb-4 drop-shadow-2xl"
          alt="Logo"
        />
        <h1 class="text-4xl font-extrabold text-white tracking-tight">
          Routine Runner
        </h1>
      </div>
      <p class="text-slate-400 mb-8 text-center max-w-xs">
        Sync your discipline across devices.
      </p>
      <button
        id="google-login-btn"
        class="flex items-center gap-3 bg-white text-slate-900 px-6 py-3 rounded-xl font-bold hover:bg-slate-100 transition shadow-lg active:scale-95"
      >
        <i class="fab fa-google text-red-500"></i> Continue with Google
      </button>
      <p
        id="login-error-msg"
        class="text-red-400 text-xs mt-4 hidden text-center max-w-xs"
      ></p>
      <!-- Renamed ID to avoid duplicate -->
      <button
        id="login-reset-btn"
        class="mt-8 text-slate-600 text-xs hover:text-slate-400 underline"
      >
        Reset Database Config
      </button>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="flex flex-col h-full w-full hidden">
      <!-- HEADER -->
      <header
        class="flex justify-between items-center p-4 bg-card-custom border-b border-custom shrink-0 z-30 relative shadow-sm transition-colors duration-300"
      >
        <div class="flex items-center gap-3">
          <img
            src="assets/RR.png"
            class="h-8 w-8 object-contain cursor-pointer active:scale-95 transition"
            id="home-logo-btn"
            alt="RR Logo"
          />
          <div
            class="flex items-center cursor-pointer"
            id="sync-wrapper"
            title="Force Sync"
          >
            <div
              id="sync-indicator"
              class="w-2 h-2 rounded-full bg-slate-500 mr-2"
            ></div>
            <span
              id="sync-status"
              class="text-[10px] text-muted-custom uppercase font-bold transition-opacity duration-300"
              >Offline</span
            >
          </div>
        </div>
        <div class="flex items-center gap-4">
          <img
            id="user-avatar"
            src=""
            class="w-8 h-8 rounded-full border border-custom"
            alt="User"
          />
          <button
            id="settings-btn"
            class="text-muted-custom hover:text-blue-500 transition"
          >
            <i class="fas fa-cog text-xl"></i>
          </button>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <main class="flex-1 relative overflow-hidden">
        <!-- SETTINGS VIEW -->
        <div
          id="settings-view"
          class="absolute inset-0 bg-card-custom z-40 transform translate-x-full transition-transform duration-300 flex flex-col p-6 overflow-y-auto"
        >
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold">Settings</h2>
            <button
              id="close-settings-btn"
              class="text-muted-custom hover:text-red-500"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Main Actions -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <button
              id="edit-routine-btn"
              class="col-span-2 py-4 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg flex items-center justify-center gap-2"
            >
              <i class="fas fa-pen"></i> Edit Routine
            </button>
          </div>

          <!-- Log Management -->
          <div class="mb-6">
            <h3
              class="text-xs font-bold text-muted-custom uppercase mb-3 tracking-wider"
            >
              Weekly Review & Logs
            </h3>
            <button
              id="manage-logs-btn"
              class="w-full py-3 rounded-lg border border-custom text-blue-400 hover:bg-blue-500/10 font-medium flex justify-between items-center px-4"
            >
              <span
                ><i class="fas fa-file-code mr-2"></i> Manage / Export
                Logs</span
              >
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>

          <!-- Toggles -->
          <div class="space-y-4 mb-8">
            <!-- Theme -->
            <div
              class="flex justify-between items-center p-4 border border-custom rounded-xl"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-moon text-blue-400"></i>
                <span class="font-medium">Dark Mode</span>
              </div>
              <div class="relative inline-block w-10 align-middle select-none">
                <input
                  type="checkbox"
                  id="theme-toggle"
                  class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                />
                <label
                  for="theme-toggle"
                  class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"
                ></label>
              </div>
            </div>

            <!-- Auto Advance -->
            <div
              class="flex justify-between items-center p-4 border border-custom rounded-xl"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-forward text-emerald-400"></i>
                <div>
                  <span class="font-medium block">Auto Advance</span>
                  <span class="text-xs text-muted-custom"
                    >Next task without alarm</span
                  >
                </div>
              </div>
              <div class="relative inline-block w-10 align-middle select-none">
                <input
                  type="checkbox"
                  id="auto-advance-toggle"
                  class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                />
                <label
                  for="auto-advance-toggle"
                  class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"
                ></label>
              </div>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="space-y-4 mt-auto border-t border-custom pt-6">
            <!-- Refresh -->
            <button
              id="refresh-btn"
              class="w-full flex justify-between items-center p-4 border border-custom rounded-xl hover:bg-slate-700/10 transition"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-sync-alt text-blue-400"></i>
                <span class="font-medium">Refresh App</span>
              </div>
              <i class="fas fa-chevron-right text-xs text-muted-custom"></i>
            </button>

            <!-- Reset Day -->
            <button
              id="reset-day-btn"
              class="w-full flex justify-between items-center p-4 border border-custom rounded-xl hover:bg-yellow-500/10 transition group"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-undo text-yellow-500"></i>
                <span class="font-medium text-yellow-500"
                  >Reset Day Progress</span
                >
              </div>
              <i
                class="fas fa-exclamation-triangle text-xs text-yellow-500 opacity-50 group-hover:opacity-100"
              ></i>
            </button>

            <!-- Sign Out -->
            <button
              id="settings-logout-btn"
              class="w-full flex justify-between items-center p-4 border border-custom rounded-xl hover:bg-red-500/10 transition group"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-sign-out-alt text-red-500"></i>
                <span class="font-bold text-red-500">Sign Out</span>
              </div>
              <i
                class="fas fa-power-off text-xs text-red-500 opacity-50 group-hover:opacity-100"
              ></i>
            </button>

            <!-- Disconnect -->
            <button
              id="settings-disconnect-btn"
              class="w-full flex justify-center items-center py-2 text-xs text-muted-custom hover:text-red-400 transition"
            >
              <i class="fas fa-unlink mr-2"></i> Disconnect Database
            </button>
          </div>

          <div class="mt-6 text-center">
            <p class="text-[10px] text-muted-custom mono">
              ID: <span id="user-id-display">...</span>
            </p>
          </div>
        </div>

        <!-- EDIT VIEW -->
        <div
          id="edit-view"
          class="absolute inset-0 bg-card-custom flex flex-col p-4 transition-transform duration-300 translate-x-full z-30"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Edit Routine</h2>
            <button
              id="close-edit-btn"
              class="text-muted-custom hover:text-white"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <textarea
            id="routine-input"
            class="flex-1 text-main p-4 rounded-xl mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500/50 leading-relaxed placeholder-slate-500 mb-4 border border-custom"
            style="background-color: rgba(0, 0, 0, 0.2)"
            spellcheck="false"
            placeholder="Wake up [@06:30]&#10;Work [=>5:00 pm]&#10;Read [30m]"
          ></textarea>
          <div class="flex justify-between items-center">
            <p class="text-xs text-muted-custom">Auto-saves to cloud</p>
            <button
              id="save-routine-btn"
              class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg shadow-emerald-900/20 active:scale-95 transition w-full"
            >
              Save & Run
            </button>
          </div>
        </div>

        <!-- LOG MANAGER MODAL -->
        <div
          id="log-manager-modal"
          class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col p-4"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Log Manager</h2>
            <button id="close-logs-btn" class="text-slate-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <p class="text-xs text-slate-400 mb-2">
            Edit JSON directly to modify history. Careful!
          </p>
          <textarea
            id="logs-input"
            class="flex-1 bg-slate-800 text-green-400 p-4 rounded-xl mono text-xs resize-none focus:outline-none border border-slate-700 mb-4"
          ></textarea>
          <div class="grid grid-cols-3 gap-2">
            <button
              id="copy-logs-btn"
              class="py-3 bg-slate-800 text-white rounded-lg border border-slate-700 font-bold"
            >
              Copy
            </button>
            <button
              id="download-logs-btn"
              class="py-3 bg-slate-800 text-white rounded-lg border border-slate-700 font-bold"
            >
              Download
            </button>
            <button
              id="save-logs-btn"
              class="py-3 bg-blue-600 text-white rounded-lg font-bold"
            >
              Save Edits
            </button>
          </div>
        </div>

        <!-- RUN VIEW -->
        <div
          id="run-view"
          class="absolute inset-0 overflow-y-auto scroll-touch"
        >
          <div
            class="min-h-full flex flex-col items-center justify-center p-6 pb-24"
          >
            <!-- Empty State -->
            <div id="empty-state" class="text-center hidden">
              <i class="fas fa-wind text-6xl text-slate-500 mb-4"></i>
              <h2 class="text-xl font-bold">No Routine Set</h2>
              <p class="text-muted-custom mt-2">
                Go to Settings > Edit Routine.
              </p>
            </div>

            <!-- Done State -->
            <div id="all-done-state" class="text-center hidden">
              <i
                class="fas fa-trophy text-6xl text-yellow-500 mb-4 animate-bounce"
              ></i>
              <h2 class="text-2xl font-bold">Day Complete</h2>
              <p class="text-muted-custom mt-2">Discipline is freedom.</p>
            </div>

            <!-- Active Task Card -->
            <div
              id="active-task-container"
              class="w-full max-w-md flex flex-col gap-6 hidden"
            >
              <!-- Progress -->
              <div
                class="w-full bg-card-custom border border-custom h-1.5 rounded-full overflow-hidden shrink-0"
              >
                <div
                  id="global-progress"
                  class="bg-blue-500 h-full w-0 transition-all duration-500"
                ></div>
              </div>

              <!-- Main Card -->
              <div
                id="task-card"
                class="bg-card-custom border border-custom rounded-2xl p-8 flex flex-col items-center text-center shadow-2xl relative overflow-hidden task-card shrink-0"
              >
                <!-- Wait Overlay -->
                <div
                  id="wait-overlay"
                  class="absolute inset-0 bg-black/90 z-10 flex flex-col items-center justify-center hidden"
                >
                  <i
                    class="fas fa-hourglass-half text-blue-400 text-3xl mb-3 animate-pulse"
                  ></i>
                  <h3 class="text-lg font-bold text-blue-200">
                    Waiting for <span id="wait-target-time">05:00</span>
                  </h3>
                  <p class="text-slate-400 mono mt-2" id="wait-countdown">
                    00:00:00
                  </p>
                  <button
                    id="force-start-btn"
                    class="mt-8 px-4 py-2 bg-slate-800 text-slate-400 rounded-lg text-xs hover:text-white border border-slate-700"
                  >
                    Force Start
                  </button>
                </div>

                <!-- Content -->
                <div class="mb-6">
                  <span
                    id="task-icon"
                    class="text-6xl mb-4 block transform hover:scale-110 transition cursor-default"
                    >✅</span
                  >
                  <h2 id="task-text" class="text-3xl font-bold leading-tight">
                    Task Name
                  </h2>
                </div>

                <!-- Timer -->
                <div id="timer-display" class="hidden mb-6">
                  <div
                    class="text-5xl font-mono font-bold text-emerald-500 tracking-wider"
                    id="timer-val"
                  >
                    00:00
                  </div>
                  <div
                    class="text-xs text-emerald-600/70 font-bold uppercase tracking-widest mt-1"
                  >
                    Remaining
                  </div>
                </div>

                <!-- Quick Edit -->
                <button
                  id="quick-edit-btn"
                  class="absolute top-4 right-4 text-muted-custom hover:text-blue-500 transition p-2"
                >
                  <i class="fas fa-pencil-alt text-sm"></i>
                </button>
              </div>

              <!-- Next Preview -->
              <div class="text-center opacity-70 shrink-0">
                <p
                  class="text-[10px] text-muted-custom uppercase tracking-widest mb-1"
                >
                  Up Next
                </p>
                <p id="next-task-text" class="font-medium truncate">...</p>
              </div>

              <!-- Controls -->
              <div class="grid grid-cols-5 gap-3 mt-4 shrink-0">
                <button
                  id="undo-btn"
                  class="col-span-1 bg-card-custom border border-custom hover:bg-slate-700/10 text-muted-custom py-4 rounded-xl font-bold transition flex items-center justify-center"
                >
                  <i class="fas fa-undo"></i>
                </button>
                <button
                  id="skip-btn"
                  class="col-span-1 bg-card-custom border border-custom hover:bg-slate-700/10 text-muted-custom py-4 rounded-xl font-bold transition"
                >
                  Skip
                </button>
                <button
                  id="done-btn"
                  class="col-span-3 bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/30 active:scale-95 transition"
                >
                  DONE
                </button>
              </div>

              <!-- Timer Controls -->
              <div
                id="timer-controls"
                class="flex justify-center gap-3 hidden shrink-0"
              >
                <button
                  onclick="adjustTimer(60)"
                  class="px-3 py-1 rounded bg-card-custom border border-custom text-xs text-muted-custom"
                >
                  +1m
                </button>
                <button
                  onclick="adjustTimer(300)"
                  class="px-3 py-1 rounded bg-card-custom border border-custom text-xs text-muted-custom"
                >
                  +5m
                </button>
                <button
                  id="pause-btn"
                  class="px-3 py-1 rounded bg-yellow-500/10 border border-yellow-500/50 text-xs text-yellow-500 hover:bg-yellow-500/20"
                >
                  <i class="fas fa-pause"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Quick Edit Modal -->
    <div
      id="quick-edit-modal"
      class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-card-custom border border-custom w-full max-w-sm rounded-xl p-4 shadow-2xl"
      >
        <h3 class="font-bold mb-2">Fix Current Line</h3>
        <input
          type="text"
          id="quick-edit-input"
          class="w-full bg-body text-main p-3 rounded-lg border border-custom focus:border-blue-500 outline-none mb-4 mono"
        />
        <div class="flex justify-end gap-2">
          <button id="cancel-quick-edit" class="px-4 py-2 text-muted-custom">
            Cancel
          </button>
          <button
            id="save-quick-edit"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg"
          >
            Update
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // CONFIG
      const CONFIG_KEY = "rr_firebase_config";
      const ALARM_FILE = "assets/iphone_alarm.mp3";

      // DOM
      const screens = {
        setup: document.getElementById("setup-screen"),
        login: document.getElementById("login-screen"),
        app: document.getElementById("app-screen"),
      };
      const views = {
        edit: document.getElementById("edit-view"),
        run: document.getElementById("run-view"),
        settings: document.getElementById("settings-view"),
        logs: document.getElementById("log-manager-modal"),
      };
      const inputs = {
        routine: document.getElementById("routine-input"),
        logs: document.getElementById("logs-input"),
      };
      const display = {
        taskCard: document.getElementById("task-card"),
        taskText: document.getElementById("task-text"),
        taskIcon: document.getElementById("task-icon"),
        nextTask: document.getElementById("next-task-text"),
        timerBox: document.getElementById("timer-display"),
        timerVal: document.getElementById("timer-val"),
        waitOverlay: document.getElementById("wait-overlay"),
        waitTarget: document.getElementById("wait-target-time"),
        waitCount: document.getElementById("wait-countdown"),
        globalProgress: document.getElementById("global-progress"),
        syncStatus: document.getElementById("sync-status"),
        syncIndicator: document.getElementById("sync-indicator"),
        userId: document.getElementById("user-id-display"),
      };
      const toggles = {
        theme: document.getElementById("theme-toggle"),
        autoAdvance: document.getElementById("auto-advance-toggle"),
      };

      // GLOBAL STATE
      let appState = {
        rawRoutine: "",
        currentTaskIndex: 0,
        tasks: [],
        history: {}, // Keyed by YYYY-MM-DD
        settings: {
          darkMode: true,
          autoAdvance: false,
        },
        isPaused: false,
      };
      let app, auth, db, user;
      let timerInterval, alarmLoopInterval, wakeLock;
      const alarmAudio = new Audio(ALARM_FILE);
      alarmAudio.loop = true;

      // --- INIT ---
      function init() {
        if (
          "serviceWorker" in navigator &&
          (location.protocol === "http:" || location.protocol === "https:")
        ) {
          navigator.serviceWorker.register("sw.js").catch(console.error);
        }

        const savedSettings = localStorage.getItem("rr_settings");
        if (savedSettings)
          appState.settings = {
            ...appState.settings,
            ...JSON.parse(savedSettings),
          };
        applySettings();

        const storedConfig = localStorage.getItem(CONFIG_KEY);
        if (storedConfig) {
          try {
            initFirebase(JSON.parse(storedConfig));
          } catch (e) {
            showScreen("setup");
          }
        } else {
          showScreen("setup");
        }
        setupEventListeners();
      }

      function applySettings() {
        if (appState.settings.darkMode) {
          document.body.classList.remove("light-mode");
          document.getElementById("theme-color-meta").content = "#0f172a";
        } else {
          document.body.classList.add("light-mode");
          document.getElementById("theme-color-meta").content = "#f1f5f9";
        }
        toggles.theme.checked = appState.settings.darkMode;
        toggles.autoAdvance.checked = appState.settings.autoAdvance;
      }

      function initFirebase(config) {
        try {
          app = initializeApp(config);
          auth = getAuth(app);
          db = getFirestore(app);

          onAuthStateChanged(auth, (u) => {
            if (u) {
              user = u;
              document.getElementById("user-avatar").src = u.photoURL;
              display.userId.innerText = u.uid.substring(0, 8) + "...";
              showScreen("app");
              initFirestoreListener();
              requestWakeLock();
            } else {
              showScreen("login");
            }
          });
        } catch (e) {
          localStorage.removeItem(CONFIG_KEY);
          location.reload();
        }
      }

      function initFirestoreListener() {
        if (!user) return;
        const docRef = doc(db, "users", user.uid);
        showSyncStatus("Connecting...", "yellow");

        onSnapshot(
          docRef,
          (docSnap) => {
            showSyncStatus("Synced", "emerald");
            if (docSnap.exists()) {
              const data = docSnap.data();
              // Merge remote data
              appState.rawRoutine = data.rawRoutine || "";
              appState.currentTaskIndex = data.currentTaskIndex || 0;
              appState.history = data.history || {}; // Sync History

              if (document.activeElement !== inputs.routine)
                inputs.routine.value = appState.rawRoutine;
              parseAndRender();
            } else if (!appState.rawRoutine) {
              appState.rawRoutine = "";
              views.edit.classList.remove("translate-x-full");
            }
          },
          (error) => {
            showSyncStatus("Error!", "red");
          }
        );
      }

      async function saveStateToCloud() {
        if (!user) return;
        showSyncStatus("Saving...", "blue");
        try {
          await setDoc(
            doc(db, "users", user.uid),
            {
              rawRoutine: appState.rawRoutine,
              currentTaskIndex: appState.currentTaskIndex,
              history: appState.history,
              lastUpdated: Date.now(),
            },
            { merge: true }
          );
          showSyncStatus("Synced", "emerald");
        } catch (e) {
          showSyncStatus("Error!", "red");
        }
      }

      function showSyncStatus(msg, color) {
        display.syncStatus.innerText =
          msg === "Synced"
            ? `Synced ${new Date().toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              })}`
            : msg;
        display.syncIndicator.className = `w-2 h-2 rounded-full mr-2 transition-colors duration-300 ${
          color === "emerald"
            ? "bg-emerald-500"
            : color === "yellow"
            ? "bg-yellow-500"
            : color === "red"
            ? "bg-red-500"
            : "bg-blue-500"
        }`;
      }

      // --- LOGGING ---
      function logTask(status) {
        const task = appState.tasks[appState.currentTaskIndex];
        if (!task) return;

        const today = new Date().toISOString().split("T")[0];
        if (!appState.history[today]) appState.history[today] = [];

        appState.history[today].push({
          time: new Date().toLocaleTimeString(),
          task: task.text,
          status: status,
        });
        // State is saved after this call in actions
      }

      // --- LOGIC & RENDERER ---
      // --- CONDITIONALS ---
      function checkCondition(cond) {
        const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        const today = days[new Date().getDay()];
        if (cond.startsWith("!")) {
            return today !== cond.substring(1);
        }
        return today === cond;
      }


      function parseRoutine(text) {
        const lines = text.split("\n");
        return lines
          .map((line, index) => {
            if (line.trim() === "") return null;
            let rawLine = line.trim();

            // 1. Logic Pre-processor (IF/ELSE)
            if (rawLine.startsWith("IF:")) {
                const parts = rawLine.split("::");
                if (parts.length >= 2) {
                    const condition = parts[0].substring(3); // Remove "IF:"
                    const mainTask = parts[1];
                    const elsePart = rawLine.includes("| ELSE::") ? rawLine.split("| ELSE::")[1] : null;

                    if (checkCondition(condition)) {
                        rawLine = mainTask;
                    } else if (elsePart) {
                        rawLine = elsePart;
                    } else {
                        return null; // Skip this task
                    }
                }
            }

            let type = "standard",
              meta = null,
              cleanText = rawLine;

            // 2. Bracket Syntax Parser
            // [@HH:MM] - Gate
            const gateMatch = rawLine.match(/\[@(\d{1,2}:\d{2})\]/);
            if (gateMatch) {
              type = "gate";
              meta = gateMatch[1];
              cleanText = cleanText.replace(gateMatch[0], "").trim();
            }

            // [=>HH:MM] - Till
            const tillMatch = rawLine.match(/\[=>(\d{1,2}:\d{2})\]/);
            if (tillMatch) {
              type = "till";
              meta = tillMatch[1];
              cleanText = cleanText.replace(tillMatch[0], "").trim();
            }

            // [Xm] - Timer
            const durationMatch = rawLine.match(/\[(\d+)m\]/i);
            if (durationMatch) {
              type = "timer";
              meta = parseInt(durationMatch[1]) * 60;
              cleanText = cleanText.replace(durationMatch[0], "").trim();
            }

            const highMatch = rawLine.match(/==(.*?)==/);
            let isHigh = false;
            if (highMatch) {
              isHigh = true;
              cleanText = cleanText.replace(/==/g, "").trim();
              cleanText = cleanText.replace(highMatch[1], highMatch[1]); // Keep text, remove brackets logic handled by replace above technically
              cleanText = cleanText.replace(/==/g, ""); // Clean up
            }

            const emojiMatch = cleanText.match(
              /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u
            );
            const icon = emojiMatch ? emojiMatch[0] : "✅";
            // Final cleanup of cleanText to remove any # comments if user adds them
            cleanText = cleanText.split("#")[0].trim();
            const displayText = cleanText.replace(icon, "").trim();

            return {
              id: index,
              raw: line,
              text: displayText,
              icon,
              type,
              meta,
              isHigh,
            };
          })
          .filter((t) => t !== null);
      }

            const emojiMatch = cleanText.match(
              /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u
            );
            const icon = emojiMatch ? emojiMatch[0] : "✅";
            const displayText = cleanText.replace(icon, "").trim();

            return {
              id: index,
              raw: line,
              text: displayText,
              icon,
              type,
              meta,
              isHigh,
            };
          })
          .filter((t) => t !== null);
      }

      function parseAndRender() {
        appState.tasks = parseRoutine(appState.rawRoutine);
        stopAlarm();
        clearInterval(timerInterval);

        if (appState.currentTaskIndex >= appState.tasks.length) {
          document
            .getElementById("active-task-container")
            .classList.add("hidden");
          document.getElementById("all-done-state").classList.remove("hidden");
          document.getElementById("empty-state").classList.add("hidden");
          return;
        }
        if (appState.tasks.length === 0) {
          document.getElementById("empty-state").classList.remove("hidden");
          document
            .getElementById("active-task-container")
            .classList.add("hidden");
          return;
        }

        document.getElementById("empty-state").classList.add("hidden");
        document.getElementById("all-done-state").classList.add("hidden");
        document
          .getElementById("active-task-container")
          .classList.remove("hidden");

        const task = appState.tasks[appState.currentTaskIndex];
        const nextTask = appState.tasks[appState.currentTaskIndex + 1];

        display.taskText.innerText = task.text || "Untitled";
        display.taskIcon.innerText = task.icon;
        display.nextTask.innerText = nextTask
          ? `Next: ${nextTask.text}`
          : "Next: Finish Line";

        if (task.isHigh) display.taskCard.classList.add("priority-glow");
        else display.taskCard.classList.remove("priority-glow");

        display.globalProgress.style.width = `${
          (appState.currentTaskIndex / appState.tasks.length) * 100
        }%`;

        display.waitOverlay.classList.add("hidden");
        display.timerBox.classList.add("hidden");
        document.getElementById("timer-controls").classList.add("hidden");

        handleTaskLogic(task);
      }

      function handleTaskLogic(task) {
        if (task.type === "gate") {
          const target = getNextOccurrence(task.meta);
          if (new Date() < target) {
            display.waitOverlay.classList.remove("hidden");
            display.waitTarget.innerText = task.meta;
            startTimerCheck(() => {
              const diff = target - new Date();
              if (diff <= 0) {
                clearInterval(timerInterval);
                display.waitOverlay.classList.add("hidden");
                triggerCompletion();
              } else {
                display.waitCount.innerText = formatTime(
                  Math.floor(diff / 1000)
                );
              }
            });
          }
        } else if (task.type === "timer") {
          appState.isPaused = false;
          updatePauseBtn();
          document.getElementById("pause-btn").classList.remove("hidden");
          startCountDown(task.meta);
        } else if (task.type === "till") {
          document.getElementById("pause-btn").classList.add("hidden");
          const target = getNextOccurrence(task.meta);
          const diffSeconds = Math.floor((target - new Date()) / 1000);
          if (diffSeconds > 0) startCountDown(diffSeconds);
          else {
            display.timerVal.innerText = "00:00";
            display.timerBox.classList.remove("hidden");
          }
        }
      }

      function startCountDown(seconds) {
        display.timerBox.classList.remove("hidden");
        document.getElementById("timer-controls").classList.remove("hidden");
        let remaining = seconds;
        updateTimerDisplay(remaining);
        startTimerCheck(() => {
          remaining--;
          updateTimerDisplay(remaining);
          if (remaining <= 0) {
            clearInterval(timerInterval);
            triggerCompletion();
          }
        });
      }

      function triggerCompletion() {
        if (appState.settings.autoAdvance) {
          logTask("auto-done");
          appState.currentTaskIndex++;
          saveStateToCloud();
          parseAndRender();
        } else {
          startAlarmLoop();
        }
      }

      function startTimerCheck(cb) {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (!appState.isPaused) cb();
        }, 1000);
      }

      function togglePause() {
        appState.isPaused = !appState.isPaused;
        updatePauseBtn();
      }

      function updatePauseBtn() {
        const btn = document.getElementById("pause-btn");
        if (!btn) return;
        if (appState.isPaused) {
          btn.innerHTML = '<i class="fas fa-play"></i>';
          display.timerVal.classList.add("opacity-50");
        } else {
          btn.innerHTML = '<i class="fas fa-pause"></i>';
          display.timerVal.classList.remove("opacity-50");
        }
      }

      function startAlarmLoop() {
        alarmAudio.play().catch((e) => console.log("Audio block", e));
      }
      function stopAlarm() {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      }

      function updateTimerDisplay(s) {
        const h = Math.floor(s / 3600),
          m = Math.floor((s % 3600) / 60),
          sec = s % 60;
        display.timerVal.innerText = `${h > 0 ? h + ":" : ""}${m
          .toString()
          .padStart(2, "0")}:${sec.toString().padStart(2, "0")}`;
      }

      window.adjustTimer = (secs) => {
        stopAlarm();
        const parts = display.timerVal.innerText.split(":");
        let currentSecs =
          parts.length === 3
            ? parseInt(parts[0]) * 3600 +
              parseInt(parts[1]) * 60 +
              parseInt(parts[2])
            : parseInt(parts[0]) * 60 + parseInt(parts[1]);
        startCountDown(currentSecs + secs);
      };

      function getNextOccurrence(timeStr) {
        const [h, m] = timeStr.split(":").map(Number);
        const d = new Date();
        d.setHours(h, m, 0, 0);
        return d;
      }

      function formatTime(s) {
        const h = Math.floor(s / 3600),
          m = Math.floor((s % 3600) / 60),
          sec = s % 60;
        return `${h > 0 ? h + ":" : ""}${m.toString().padStart(2, "0")}:${sec
          .toString()
          .padStart(2, "0")}`;
      }

      async function requestWakeLock() {
        try {
          wakeLock = await navigator.wakeLock.request("screen");
          document.addEventListener("visibilitychange", async () => {
            if (wakeLock !== null && document.visibilityState === "visible")
              wakeLock = await navigator.wakeLock.request("screen");
          });
        } catch (err) {}
      }

      function setupEventListeners() {
        // Helper for safe binding
        const onClick = (id, fn) => {
          const el = document.getElementById(id);
          if (el) el.onclick = fn;
        };

        // NAV
        onClick("settings-btn", () =>
          views.settings.classList.remove("translate-x-full")
        );
        onClick("close-settings-btn", () =>
          views.settings.classList.add("translate-x-full")
        );
        onClick("home-logo-btn", () => {
          views.settings.classList.add("translate-x-full");
          views.edit.classList.add("translate-x-full");
        });

        // EDIT ROUTINE
        onClick("edit-routine-btn", () => {
          views.settings.classList.add("translate-x-full");
          views.edit.classList.remove("translate-x-full");
        });
        onClick("close-edit-btn", () =>
          views.edit.classList.add("translate-x-full")
        );

        // LOGS
        onClick("manage-logs-btn", () => {
          inputs.logs.value = JSON.stringify(appState.history, null, 2);
          views.logs.classList.remove("hidden");
        });
        onClick("close-logs-btn", () => views.logs.classList.add("hidden"));
        onClick("copy-logs-btn", () => {
          navigator.clipboard.writeText(inputs.logs.value);
          alert("Logs copied to clipboard!");
        });
        onClick("download-logs-btn", () => {
          const blob = new Blob([inputs.logs.value], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `rr-logs-${new Date().toISOString().split("T")[0]}.json`;
          a.click();
        });
        onClick("save-logs-btn", () => {
          try {
            appState.history = JSON.parse(inputs.logs.value);
            saveStateToCloud();
            views.logs.classList.add("hidden");
          } catch (e) {
            alert("Invalid JSON format. Cannot save.");
          }
        });

        // ACTIONS
        onClick("save-routine-btn", () => {
          appState.rawRoutine = inputs.routine.value;
          appState.currentTaskIndex = 0;
          saveStateToCloud();
          views.edit.classList.add("translate-x-full");
          parseAndRender();
        });
        onClick("done-btn", () => {
          logTask("done");
          appState.currentTaskIndex++;
          saveStateToCloud();
          parseAndRender();
        });
        onClick("skip-btn", () => {
          logTask("skipped");
          appState.currentTaskIndex++;
          saveStateToCloud();
          parseAndRender();
        });
        onClick("undo-btn", () => {
          if (appState.currentTaskIndex > 0) {
            appState.currentTaskIndex--;
            saveStateToCloud();
            parseAndRender();
          }
        });
        onClick("refresh-btn", () => location.reload());
        onClick("reset-day-btn", () => {
          if (confirm("Restart day?")) {
            appState.currentTaskIndex = 0;
            saveStateToCloud();
            parseAndRender();
            views.settings.classList.add("translate-x-full");
          }
        });
        onClick("force-start-btn", () => {
          display.waitOverlay.classList.add("hidden");
          stopAlarm();
          clearInterval(timerInterval);
        });
        onClick("pause-btn", togglePause);

        // SETTINGS
        toggles.theme.addEventListener("change", (e) => {
          appState.settings.darkMode = e.target.checked;
          applySettings();
          localStorage.setItem(
            "rr_settings",
            JSON.stringify(appState.settings)
          );
        });
        toggles.autoAdvance.addEventListener("change", (e) => {
          appState.settings.autoAdvance = e.target.checked;
          localStorage.setItem(
            "rr_settings",
            JSON.stringify(appState.settings)
          );
        });

        // AUTH & CONFIG
        onClick("save-config-btn", async () => {
          const val = document.getElementById("config-input").value.trim();
          try {
            let config = val.startsWith("http")
              ? await (await fetch(val)).json()
              : JSON.parse(val);
            if (!config.projectId) throw new Error();
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            location.reload();
          } catch (e) {
            document.getElementById("setup-error").innerText = "Invalid Config";
            document.getElementById("setup-error").classList.remove("hidden");
          }
        });

        const disconnectHandler = () => {
          if (confirm("Disconnect?")) {
            localStorage.removeItem(CONFIG_KEY);
            location.reload();
          }
        };
        onClick("login-reset-btn", disconnectHandler);
        onClick("settings-disconnect-btn", disconnectHandler);

        onClick("google-login-btn", () =>
          signInWithPopup(auth, new GoogleAuthProvider()).catch((e) =>
            alert(e.message)
          )
        );
        onClick("settings-logout-btn", () => {
          if (confirm("Sign out?")) signOut(auth);
        });

        // QUICK EDIT
        onClick("quick-edit-btn", () => {
          const task = appState.tasks[appState.currentTaskIndex];
          if (task) {
            document.getElementById("quick-edit-input").value = task.raw;
            document
              .getElementById("quick-edit-modal")
              .classList.remove("hidden");
          }
        });
        onClick("cancel-quick-edit", () =>
          document.getElementById("quick-edit-modal").classList.add("hidden")
        );
        onClick("save-quick-edit", () => {
          const newVal = document.getElementById("quick-edit-input").value;
          const taskID = appState.tasks[appState.currentTaskIndex].id;
          const lines = appState.rawRoutine.split("\n");
          if (lines[taskID] !== undefined) {
            lines[taskID] = newVal;
            appState.rawRoutine = lines.join("\n");
            saveStateToCloud();
            document.getElementById("quick-edit-modal").classList.add("hidden");
          }
        });
      }

      function showScreen(name) {
        Object.values(screens).forEach((el) => el.classList.add("hidden"));
        screens[name].classList.remove("hidden");
      }
      window.addEventListener("load", init);
    </script>
  </body>
</html>
