<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Routine Runner</title>
    <meta
      name="description"
      content="A premium, distraction-free Progressive Web App designed to execute daily routines with precision. Features smart text-based schedules, real-time sync across devices, and prayer time integration."
    />

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0f172a" id="theme-color-meta" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="icon" href="assets/RR.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap");

      /* Base Variables */
      :root {
        --bg-body: #0f172a;
        --bg-card: rgba(30, 41, 59, 0.7);
        --text-main: #e2e8f0;
        --text-muted: #94a3b8;
        --border: rgba(255, 255, 255, 0.1);
        --accent: #059669; /* Emerald 600 */
        --glass: blur(16px);
      }

      /* Light Mode Overrides */
      .light-mode {
        --bg-body: #f1f5f9;
        --bg-card: rgba(255, 255, 255, 0.82);
        --text-main: #1f2937;
        --text-muted: #64748b;
        --border: rgba(0, 0, 0, 0.08); /* Softer border */
        --accent: #10b981; /* Emerald 500 */
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        overscroll-behavior-y: none;
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
        background-attachment: fixed;
      }

      /* Dynamic Backgrounds */
      body:not(.light-mode) {
        background-image: radial-gradient(
          circle at 15% 50%,
          #1e293b 0%,
          #0f172a 80%
        );
      }
      body.light-mode {
        background-image: linear-gradient(135deg, #e0f2fe 0%, #f1f5f9 100%);
      }

      .bg-card-custom {
        background-color: var(--bg-card);
        backdrop-filter: var(--glass);
        -webkit-backdrop-filter: var(--glass);
      }
      /* Fixed Utility Classes */
      .bg-body {
        background-color: var(--bg-body);
      }
      .text-main {
        color: var(--text-main);
      }
      .text-muted-custom {
        color: var(--text-muted);
      }
      .border-custom {
        border-color: var(--border);
      }

      .mono {
        font-family: "JetBrains Mono", monospace;
      }
      .h-dvh {
        height: 100dvh;
      }
      .safe-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }
      .scroll-touch {
        -webkit-overflow-scrolling: touch;
      }

      /* Utils */
      .task-card {
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .priority-glow {
        box-shadow: 0 0 30px rgba(234, 179, 8, 0.15);
        border-color: #eab308 !important;
      }

      /* Toggle Switch */
      .toggle-checkbox:checked {
        right: 0;
        border-color: #10b981;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #10b981;
      }

      /* Fixed Bottom Controls Bar */
      #controls-bar {
        background-color: var(--bg-card);
        backdrop-filter: var(--glass);
        -webkit-backdrop-filter: var(--glass);
        border-top: 1px solid var(--border);
        padding: 1rem;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      }

      /* Landscape Mode Styles */
      @media (orientation: landscape) and (max-height: 500px) {
        /* Compact header */
        header {
          padding: 0.5rem 1rem;
        }
        header img {
          height: 1.5rem;
          width: 1.5rem;
        }

        /* Run view becomes horizontal */
        #run-view {
          flex-direction: row !important;
        }

        /* Scrollable content takes most of the space */
        #run-view > div:first-child {
          flex: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow-y: auto;
        }

        /* Task card area adjustments */
        #active-task-container {
          max-width: 100%;
          padding: 0.5rem 1rem;
          gap: 0.5rem;
        }

        #task-card {
          padding: 1rem 1.5rem;
        }

        #task-icon {
          font-size: 2.5rem !important;
          margin-bottom: 0.25rem !important;
        }

        #task-text {
          font-size: 1.25rem !important;
        }

        #timer-val,
        #wait-countdown {
          font-size: 2rem !important;
        }

        .up-next-container {
          display: none;
        }

        /* Controls bar becomes side panel */
        #controls-bar {
          width: 140px;
          min-width: 140px;
          height: auto;
          align-self: stretch;
          border-top: none;
          border-left: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          justify-content: center;
          gap: 0.5rem;
          padding: 1rem !important;
        }

        #controls-bar .controls-grid {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          max-width: 100%;
        }

        #controls-bar .controls-grid button {
          width: 100%;
        }

        #controls-bar #done-btn {
          order: -1;
          padding: 1.5rem 1rem;
          grid-column: span 1;
        }

        #controls-bar #skip-btn,
        #controls-bar #undo-btn {
          padding: 0.75rem;
          grid-column: span 1;
        }

        /* Hide timer controls in landscape to save space */
        #timer-controls {
          display: none !important;
        }

        /* Hide progress bar in landscape to save space */
        #active-task-container > div:first-child {
          height: 0.25rem;
        }
      }

      /* Very small landscape (phone in landscape) */
      @media (orientation: landscape) and (max-height: 400px) {
        header {
          padding: 0.25rem 0.75rem;
        }

        #task-icon {
          font-size: 2rem !important;
        }

        #task-text {
          font-size: 1.1rem !important;
        }

        #timer-val,
        #wait-countdown {
          font-size: 1.5rem !important;
        }

        #controls-bar {
          width: 120px;
          min-width: 120px;
          padding: 0.5rem !important;
        }
      }
    </style>
  </head>
  <body class="h-dvh w-screen overflow-hidden flex flex-col safe-bottom">
    <!-- SETUP SCREEN -->
    <!-- SETUP SCREEN REMOVED -->

    <!-- LOGIN SCREEN -->
    <div
      id="login-screen"
      class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6 hidden"
    >
      <div class="mb-6 flex flex-col items-center">
        <img
          src="assets/RR.png"
          class="h-24 w-24 object-contain mb-4 drop-shadow-2xl"
          alt="Logo"
        />
        <h1 class="text-4xl font-extrabold text-white tracking-tight">
          Routine Runner
        </h1>
      </div>
      <p class="text-slate-400 mb-8 text-center max-w-xs">
        Sync your discipline across devices.
      </p>
      <button
        id="google-login-btn"
        class="flex items-center gap-3 bg-white text-slate-900 px-6 py-3 rounded-xl font-bold hover:bg-slate-100 transition shadow-lg active:scale-95"
      >
        <i class="fab fa-google text-red-500"></i> Continue with Google
      </button>
      <p
        id="login-error-msg"
        class="text-red-400 text-xs mt-4 hidden text-center max-w-xs"
      ></p>
      <!-- Sign out option on login screen -->
      <button
        id="login-reset-btn"
        class="mt-8 text-slate-600 text-xs hover:text-slate-400 underline"
      >
        Sign Out
      </button>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="flex flex-col h-full w-full hidden">
      <!-- HEADER -->
      <header
        class="flex justify-between items-center p-4 bg-card-custom border-b border-custom shrink-0 z-30 relative shadow-sm transition-colors duration-300"
      >
        <div class="flex items-center gap-3">
          <img
            src="assets/RR.png"
            class="h-8 w-8 object-contain cursor-pointer active:scale-95 transition"
            id="home-logo-btn"
            alt="RR Logo"
          />
          <div
            class="flex items-center cursor-pointer"
            id="sync-wrapper"
            title="Force Sync"
          >
            <div
              id="sync-indicator"
              class="w-2 h-2 rounded-full bg-slate-500 mr-2"
            ></div>
            <span
              id="sync-status"
              class="text-[10px] text-muted-custom uppercase font-bold transition-opacity duration-300"
              >Offline</span
            >
          </div>
        </div>
        <div class="flex items-center gap-4">
          <img
            id="user-avatar"
            src=""
            class="w-8 h-8 rounded-full border border-custom"
            alt="User"
          />
          <button
            id="settings-btn"
            class="text-muted-custom hover:text-blue-500 transition"
          >
            <i class="fas fa-cog text-xl"></i>
          </button>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <main class="flex-1 relative overflow-hidden">
        <!-- SETTINGS VIEW -->
        <div
          id="settings-view"
          class="absolute inset-0 bg-card-custom z-40 transform translate-x-full transition-transform duration-300 flex flex-col p-6 overflow-y-auto"
        >
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold">Settings</h2>
            <button
              id="close-settings-btn"
              class="text-muted-custom hover:text-red-500"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Main Actions -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <button
              id="manage-routines-btn"
              class="col-span-2 py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg flex items-center justify-center gap-2"
            >
              <i class="fas fa-layer-group"></i> Manage Routines
            </button>
            <button
              id="edit-routine-btn"
              class="col-span-2 py-3 rounded-xl border border-custom hover:bg-slate-700/10 text-muted-custom font-medium flex items-center justify-center gap-2"
            >
              <i class="fas fa-pen"></i> Edit Current Routine
            </button>
          </div>

          <!-- Current Routine Indicator -->
          <div class="mb-6 p-3 rounded-lg border border-custom bg-card-custom">
            <p class="text-xs text-muted-custom uppercase tracking-wider mb-1">
              Active Routine
            </p>
            <p id="active-routine-name" class="font-bold text-emerald-400">
              Daily Routine
            </p>
          </div>

          <!-- Log Management -->
          <div class="mb-6">
            <h3
              class="text-xs font-bold text-muted-custom uppercase mb-3 tracking-wider"
            >
              Weekly Review & Logs
            </h3>
            <button
              id="manage-logs-btn"
              class="w-full py-3 rounded-lg border border-custom text-blue-400 hover:bg-blue-500/10 font-medium flex justify-between items-center px-4"
            >
              <span
                ><i class="fas fa-file-code mr-2"></i> Manage / Export
                Logs</span
              >
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>

          <!-- Prayer Time Settings -->
          <div class="mb-6">
            <h3
              class="text-xs font-bold text-muted-custom uppercase mb-3 tracking-wider"
            >
              Prayer Times
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-muted-custom mb-1"
                  >Latitude</label
                >
                <div class="flex gap-2">
                  <input
                    type="number"
                    id="prayer-latitude"
                    step="any"
                    class="flex-1 bg-body text-main p-2 rounded-lg border border-custom focus:border-blue-500 outline-none text-sm"
                    placeholder="e.g., 11.2098095"
                  />
                  <button
                    id="get-location-btn"
                    class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium"
                    title="Get from GPS"
                  >
                    <i class="fas fa-map-marker-alt"></i>
                  </button>
                </div>
              </div>
              <div>
                <label class="block text-xs text-muted-custom mb-1"
                  >Longitude</label
                >
                <input
                  type="number"
                  id="prayer-longitude"
                  step="any"
                  class="w-full bg-body text-main p-2 rounded-lg border border-custom focus:border-blue-500 outline-none text-sm"
                  placeholder="e.g., 75.815483"
                />
              </div>
              <button
                id="save-prayer-location-btn"
                class="w-full py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium text-sm"
              >
                Save Location
              </button>
              <div
                class="text-xs text-muted-custom p-2 bg-card-custom rounded border border-custom"
              >
                <p class="mb-1">
                  <strong>Prayer Names:</strong> Fajr, Dhuhr, Asr, Maghrib, Isha
                </p>
                <p class="text-[10px]">
                  Use in routines:
                  <code class="bg-body px-1 rounded">[@Prayer:Fajr]</code> or
                  <code class="bg-body px-1 rounded">[=>Prayer:Dhuhr]</code>
                </p>
              </div>
            </div>
          </div>

          <!-- Toggles -->
          <div class="space-y-4 mb-8">
            <!-- Theme -->
            <div
              class="flex justify-between items-center p-4 border border-custom rounded-xl"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-moon text-blue-400"></i>
                <span class="font-medium">Dark Mode</span>
              </div>
              <div class="relative inline-block w-10 align-middle select-none">
                <input
                  type="checkbox"
                  id="theme-toggle"
                  class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                />
                <label
                  for="theme-toggle"
                  class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"
                ></label>
              </div>
            </div>

            <!-- Auto Advance -->
            <div
              class="flex justify-between items-center p-4 border border-custom rounded-xl"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-forward text-emerald-400"></i>
                <div>
                  <span class="font-medium block">Auto Advance</span>
                  <span class="text-xs text-muted-custom"
                    >Next task without alarm</span
                  >
                </div>
              </div>
              <div class="relative inline-block w-10 align-middle select-none">
                <input
                  type="checkbox"
                  id="auto-advance-toggle"
                  class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                />
                <label
                  for="auto-advance-toggle"
                  class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"
                ></label>
              </div>
            </div>

            <!-- Wake Lock -->
            <div
              class="flex justify-between items-center p-4 border border-custom rounded-xl"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-sun text-yellow-400"></i>
                <div>
                  <span class="font-medium block">Wake Lock</span>
                  <span class="text-xs text-muted-custom">Keep screen on</span>
                </div>
              </div>
              <div class="relative inline-block w-10 align-middle select-none">
                <input
                  type="checkbox"
                  id="wake-lock-toggle"
                  checked
                  class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                />
                <label
                  for="wake-lock-toggle"
                  class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"
                ></label>
              </div>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="space-y-4 mt-auto border-t border-custom pt-6">
            <!-- Refresh -->
            <button
              id="refresh-btn"
              class="w-full flex justify-between items-center p-4 border border-custom rounded-xl hover:bg-slate-700/10 transition"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-sync-alt text-blue-400"></i>
                <span class="font-medium">Refresh App</span>
              </div>
              <i class="fas fa-chevron-right text-xs text-muted-custom"></i>
            </button>

            <!-- Reset Day -->
            <button
              id="reset-day-btn"
              class="w-full flex justify-between items-center p-4 border border-custom rounded-xl hover:bg-yellow-500/10 transition group"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-undo text-yellow-500"></i>
                <span class="font-medium text-yellow-500"
                  >Reset Day Progress</span
                >
              </div>
              <i
                class="fas fa-exclamation-triangle text-xs text-yellow-500 opacity-50 group-hover:opacity-100"
              ></i>
            </button>

            <!-- Sign Out -->
            <button
              id="settings-logout-btn"
              class="w-full flex justify-between items-center p-4 border border-custom rounded-xl hover:bg-red-500/10 transition group"
            >
              <div class="flex items-center gap-3">
                <i class="fas fa-sign-out-alt text-red-500"></i>
                <span class="font-bold text-red-500">Sign Out</span>
              </div>
              <i
                class="fas fa-power-off text-xs text-red-500 opacity-50 group-hover:opacity-100"
              ></i>
            </button>

            <!-- Disconnect -->
            <button
              id="settings-disconnect-btn"
              class="w-full flex justify-center items-center py-2 text-xs text-muted-custom hover:text-red-400 transition"
            >
              <i class="fas fa-unlink mr-2"></i> Disconnect Database
            </button>
          </div>

          <div class="mt-6 text-center">
            <p class="text-[10px] text-muted-custom mono">
              ID: <span id="user-id-display">...</span>
            </p>
          </div>
        </div>

        <!-- EDIT VIEW -->
        <div
          id="edit-view"
          class="absolute inset-0 bg-card-custom flex flex-col p-4 transition-transform duration-300 translate-x-full z-30"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Edit Routine</h2>
            <button
              id="close-edit-btn"
              class="text-muted-custom hover:text-white"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <textarea
            id="routine-input"
            class="flex-1 text-main p-4 rounded-xl mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500/50 leading-relaxed placeholder-slate-500 mb-4 border border-custom bg-black/20"
            spellcheck="false"
            placeholder="Wake up [@06:30]&#10;Work [=>5:00 pm]&#10;Read [30m]"
          ></textarea>
          <div class="flex justify-between items-center">
            <p class="text-xs text-muted-custom">Auto-saves to cloud</p>
            <button
              id="save-routine-btn"
              class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg shadow-emerald-900/20 active:scale-95 transition w-full"
            >
              Save & Run
            </button>
          </div>
        </div>

        <!-- MANAGE ROUTINES VIEW -->
        <div
          id="manage-routines-view"
          class="absolute inset-0 bg-card-custom flex flex-col p-4 transition-transform duration-300 translate-x-full z-40"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Manage Routines</h2>
            <button
              id="close-manage-routines-btn"
              class="text-muted-custom hover:text-white"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Routine List -->
          <div id="routine-list" class="flex-1 overflow-y-auto space-y-3 mb-4">
            <!-- Routines will be rendered here dynamically -->
          </div>

          <!-- Add New Routine Button -->
          <button
            id="add-routine-btn"
            class="w-full py-4 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg flex items-center justify-center gap-2"
          >
            <i class="fas fa-plus"></i> Add New Routine
          </button>
        </div>

        <!-- ROUTINE EDITOR MODAL -->
        <div
          id="routine-editor-modal"
          class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col p-4 overflow-y-auto"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 id="routine-editor-title" class="text-xl font-bold text-white">
              New Routine
            </h2>
            <button
              id="close-routine-editor-btn"
              class="text-slate-400 hover:text-white"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Routine Name -->
          <div class="mb-4">
            <label
              class="block text-xs text-slate-400 uppercase tracking-wider mb-2"
              >Routine Name</label
            >
            <input
              type="text"
              id="routine-name-input"
              class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 focus:border-blue-500 outline-none"
              placeholder="e.g., Morning Routine"
            />
          </div>

          <!-- Routine Content -->
          <div class="mb-4 flex-1 min-h-[200px] flex flex-col">
            <label
              class="block text-xs text-slate-400 uppercase tracking-wider mb-2"
              >Tasks</label
            >
            <textarea
              id="routine-content-input"
              class="flex-1 bg-slate-800 text-white p-3 rounded-lg mono text-sm resize-none focus:outline-none border border-slate-700 focus:border-blue-500"
              placeholder="ðŸ“š Study&#10;ðŸª¥ Brush [2m]&#10;ðŸ’ª Gym"
            ></textarea>
          </div>

          <!-- Condition Type -->
          <div class="mb-4">
            <label
              class="block text-xs text-slate-400 uppercase tracking-wider mb-2"
              >When to Run</label
            >
            <select
              id="routine-condition-type"
              class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 focus:border-blue-500 outline-none"
            >
              <option value="default">Always (Default)</option>
              <option value="weekday">Specific Days of Week</option>
              <option value="date">Specific Dates of Month</option>
              <option value="pattern">Pattern (First Friday, etc.)</option>
              <option value="manual">Manual Only</option>
            </select>
          </div>

          <!-- Weekday Selector (shown when condition is weekday) -->
          <div id="weekday-selector" class="mb-4 hidden">
            <label
              class="block text-xs text-slate-400 uppercase tracking-wider mb-2"
              >Select Days</label
            >
            <div class="grid grid-cols-7 gap-1">
              <button
                type="button"
                data-day="0"
                class="weekday-btn py-2 rounded bg-slate-700 text-white text-xs hover:bg-blue-600"
              >
                Sun
              </button>
              <button
                type="button"
                data-day="1"
                class="weekday-btn py-2 rounded bg-slate-700 text-white text-xs hover:bg-blue-600"
              >
                Mon
              </button>
              <button
                type="button"
                data-day="2"
                class="weekday-btn py-2 rounded bg-slate-700 text-white text-xs hover:bg-blue-600"
              >
                Tue
              </button>
              <button
                type="button"
                data-day="3"
                class="weekday-btn py-2 rounded bg-slate-700 text-white text-xs hover:bg-blue-600"
              >
                Wed
              </button>
              <button
                type="button"
                data-day="4"
                class="weekday-btn py-2 rounded bg-slate-700 text-white text-xs hover:bg-blue-600"
              >
                Thu
              </button>
              <button
                type="button"
                data-day="5"
                class="weekday-btn py-2 rounded bg-slate-700 text-white text-xs hover:bg-blue-600"
              >
                Fri
              </button>
              <button
                type="button"
                data-day="6"
                class="weekday-btn py-2 rounded bg-slate-700 text-white text-xs hover:bg-blue-600"
              >
                Sat
              </button>
            </div>
          </div>

          <!-- Date Selector (shown when condition is date) -->
          <div id="date-selector" class="mb-4 hidden">
            <label
              class="block text-xs text-slate-400 uppercase tracking-wider mb-2"
              >Select Dates (comma-separated)</label
            >
            <input
              type="text"
              id="routine-dates-input"
              class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 focus:border-blue-500 outline-none"
              placeholder="e.g., 1, 15, 28"
            />
          </div>

          <!-- Pattern Selector (shown when condition is pattern) -->
          <div id="pattern-selector" class="mb-4 hidden">
            <label
              class="block text-xs text-slate-400 uppercase tracking-wider mb-2"
              >Select Pattern</label
            >
            <select
              id="routine-pattern-input"
              class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 focus:border-blue-500 outline-none"
            >
              <option value="first-sunday">First Sunday</option>
              <option value="first-monday">First Monday</option>
              <option value="first-tuesday">First Tuesday</option>
              <option value="first-wednesday">First Wednesday</option>
              <option value="first-thursday">First Thursday</option>
              <option value="first-friday">First Friday</option>
              <option value="first-saturday">First Saturday</option>
              <option value="last-sunday">Last Sunday</option>
              <option value="last-monday">Last Monday</option>
              <option value="last-tuesday">Last Tuesday</option>
              <option value="last-wednesday">Last Wednesday</option>
              <option value="last-thursday">Last Thursday</option>
              <option value="last-friday">Last Friday</option>
              <option value="last-saturday">Last Saturday</option>
            </select>
          </div>

          <!-- Set as Default -->
          <div class="mb-6 flex items-center gap-3">
            <input
              type="checkbox"
              id="routine-is-default"
              class="w-5 h-5 rounded border-slate-600 bg-slate-700 text-emerald-500 focus:ring-emerald-500"
            />
            <label for="routine-is-default" class="text-white"
              >Set as default routine</label
            >
          </div>

          <!-- Action Buttons -->
          <div class="grid grid-cols-2 gap-3">
            <button
              id="delete-routine-btn"
              class="py-3 bg-red-600/20 text-red-400 rounded-lg border border-red-600/50 font-bold hover:bg-red-600/30 hidden"
            >
              <i class="fas fa-trash mr-2"></i>Delete
            </button>
            <button
              id="cancel-routine-editor-btn"
              class="py-3 bg-slate-700 text-white rounded-lg font-bold hover:bg-slate-600"
            >
              Cancel
            </button>
            <button
              id="save-routine-editor-btn"
              class="py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-500 col-span-1"
            >
              Save Routine
            </button>
          </div>
        </div>

        <!-- LOG MANAGER MODAL -->
        <div
          id="log-manager-modal"
          class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col p-4"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Log Manager</h2>
            <button id="close-logs-btn" class="text-slate-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <p class="text-xs text-slate-400 mb-2">
            Edit JSON directly to modify history. Careful!
          </p>
          <textarea
            id="logs-input"
            class="flex-1 bg-slate-800 text-green-400 p-4 rounded-xl mono text-xs resize-none focus:outline-none border border-slate-700 mb-4"
          ></textarea>
          <div class="grid grid-cols-3 gap-2">
            <button
              id="copy-logs-btn"
              class="py-3 bg-slate-800 text-white rounded-lg border border-slate-700 font-bold"
            >
              Copy
            </button>
            <button
              id="download-logs-btn"
              class="py-3 bg-slate-800 text-white rounded-lg border border-slate-700 font-bold"
            >
              Download
            </button>
            <button
              id="save-logs-btn"
              class="py-3 bg-blue-600 text-white rounded-lg font-bold"
            >
              Save Edits
            </button>
          </div>
        </div>

        <!-- RUN VIEW -->
        <div id="run-view" class="absolute inset-0 flex flex-col">
          <!-- Scrollable content area -->
          <div class="flex-1 overflow-y-auto scroll-touch">
            <div
              class="min-h-full flex flex-col items-center justify-center p-6"
            >
              <!-- Empty State -->
              <div id="empty-state" class="text-center hidden">
                <i class="fas fa-wind text-6xl text-slate-500 mb-4"></i>
                <h2 class="text-xl font-bold">No Routine Set</h2>
                <p class="text-muted-custom mt-2">
                  Go to Settings > Edit Routine.
                </p>
              </div>

              <!-- Done State -->
              <div id="all-done-state" class="text-center hidden">
                <i
                  class="fas fa-trophy text-6xl text-yellow-500 mb-4 animate-bounce"
                ></i>
                <h2 class="text-2xl font-bold">Day Complete</h2>
                <p class="text-muted-custom mt-2">Discipline is freedom.</p>
              </div>

              <!-- Active Task Card -->
              <div
                id="active-task-container"
                class="w-full max-w-md flex flex-col gap-6 hidden"
              >
                <!-- Progress -->
                <div
                  class="w-full bg-card-custom border border-custom h-1.5 rounded-full overflow-hidden shrink-0"
                >
                  <div
                    id="global-progress"
                    class="bg-blue-500 h-full w-0 transition-all duration-500"
                  ></div>
                </div>

                <!-- Main Card -->
                <div
                  id="task-card"
                  class="bg-card-custom border border-custom rounded-2xl p-8 flex flex-col items-center text-center shadow-2xl relative overflow-hidden task-card shrink-0"
                >
                  <!-- Wait Overlay -->
                  <div
                    id="wait-overlay"
                    class="absolute inset-0 bg-black/90 z-10 flex flex-col items-center justify-center hidden"
                  >
                    <i
                      class="fas fa-hourglass-half text-blue-400 text-3xl mb-2 animate-pulse"
                    ></i>
                    <h3 class="text-lg font-bold text-blue-200">
                      Waiting for <span id="wait-target-time">05:00</span>
                    </h3>
                    <p
                      class="text-5xl font-bold text-slate-400 mono tracking-wider mt-2"
                      id="wait-countdown"
                    >
                      00:00:00
                    </p>
                    <button
                      id="force-start-btn"
                      class="mt-6 px-4 py-2 bg-slate-800 text-slate-400 rounded-lg text-xs hover:text-white border border-slate-700"
                    >
                      Force Start
                    </button>
                  </div>

                  <!-- Content -->
                  <div class="mb-6">
                    <span
                      id="task-icon"
                      class="text-6xl mb-4 block transform hover:scale-110 transition cursor-default"
                      >âœ…</span
                    >
                    <h2
                      id="task-text"
                      class="text-3xl font-bold leading-tight line-clamp-3 break-words"
                    >
                      Task Name
                    </h2>
                    <a
                      id="task-link-btn"
                      target="_blank"
                      rel="noopener noreferrer"
                      href="#"
                      class="hidden inline-flex items-center gap-2 px-4 py-2 bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-lg hover:bg-blue-500/20 transition text-sm font-medium mt-4 cursor-pointer"
                    >
                      <i class="fas fa-external-link-alt"></i>
                      <span>Open Link</span>
                    </a>
                  </div>

                  <!-- Timer -->
                  <div id="timer-display" class="hidden mb-6">
                    <div
                      class="text-5xl font-mono font-bold text-emerald-500 tracking-wider"
                      id="timer-val"
                    >
                      00:00
                    </div>
                    <div
                      class="text-xs text-emerald-600/70 font-bold uppercase tracking-widest mt-1"
                    >
                      Remaining
                    </div>
                  </div>

                  <!-- Sub-routine Indicator (at bottom) -->
                  <p
                    id="sub-routine-indicator"
                    class="hidden text-xs text-muted-custom mt-4 uppercase tracking-wider font-medium"
                  >
                    <span id="sub-routine-parent-title"></span> [<span
                      id="sub-routine-current"
                      >1</span
                    >/<span id="sub-routine-total">3</span>]
                  </p>

                  <!-- Quick Edit -->
                  <button
                    id="quick-edit-btn"
                    class="absolute top-4 right-4 text-muted-custom hover:text-blue-500 transition p-2"
                  >
                    <i class="fas fa-pencil-alt text-sm"></i>
                  </button>
                </div>

                <!-- Up Next -->
                <div class="text-center opacity-70 shrink-0 up-next-container">
                  <p
                    class="text-[10px] text-muted-custom uppercase tracking-widest mb-1"
                  >
                    Up Next
                  </p>
                  <p id="next-task-text" class="font-medium truncate">...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Timer Controls (floating above controls bar) -->
          <div
            id="timer-controls"
            class="flex justify-center gap-3 pb-3 hidden max-w-md mx-auto px-4"
          >
            <button
              onclick="adjustTimer(60)"
              class="px-3 py-1 rounded bg-card-custom border border-custom text-xs text-muted-custom"
            >
              +1m
            </button>
            <button
              onclick="adjustTimer(300)"
              class="px-3 py-1 rounded bg-card-custom border border-custom text-xs text-muted-custom"
            >
              +5m
            </button>
            <button
              id="pause-btn"
              class="px-3 py-1 rounded bg-yellow-500/10 border border-yellow-500/50 text-xs text-yellow-500 hover:bg-yellow-500/20"
            >
              <i class="fas fa-pause"></i>
            </button>
          </div>

          <!-- Fixed Controls Bar -->
          <div id="controls-bar" class="shrink-0">
            <!-- Main Controls -->
            <div class="controls-grid grid grid-cols-5 gap-3 max-w-md mx-auto">
              <button
                id="undo-btn"
                class="col-span-1 bg-card-custom border border-custom hover:bg-slate-700/10 text-muted-custom py-4 rounded-xl font-bold transition flex items-center justify-center"
              >
                <i class="fas fa-undo"></i>
              </button>
              <button
                id="skip-btn"
                class="col-span-1 bg-card-custom border border-custom hover:bg-slate-700/10 text-muted-custom py-4 rounded-xl font-bold transition"
              >
                Skip
              </button>
              <button
                id="done-btn"
                class="col-span-3 bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/30 active:scale-95 transition"
              >
                DONE
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Quick Edit Modal -->
    <div
      id="quick-edit-modal"
      class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-card-custom border border-custom w-full max-w-sm rounded-xl p-4 shadow-2xl"
      >
        <h3 class="font-bold mb-2">Fix Current Line</h3>
        <input
          type="text"
          id="quick-edit-input"
          class="w-full bg-body text-main p-3 rounded-lg border border-custom focus:border-blue-500 outline-none mb-4 mono"
        />
        <div class="flex justify-end gap-2">
          <button id="cancel-quick-edit" class="px-4 py-2 text-muted-custom">
            Cancel
          </button>
          <button
            id="save-quick-edit"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg"
          >
            Update
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        initializeFirestore,
        persistentLocalCache,
        doc,
        onSnapshot,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // CONFIG
      // TODO: Replace with your actual Firebase Configuration
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyCCHeGuHqy2aQzwmmy7G7tGEs0v_t6hmkE",
        authDomain: "routine-runner-3b538.firebaseapp.com",
        projectId: "routine-runner-3b538",
        storageBucket: "routine-runner-3b538.firebasestorage.app",
        messagingSenderId: "1089575788718",
        appId: "1:1089575788718:web:73973fb3f8c3f909fd4d3f",
        measurementId: "G-VZM3EHHZEX",
      };

      const ALARM_FILE = "assets/iphone_alarm.mp3";

      // DOM
      const screens = {
        login: document.getElementById("login-screen"),
        app: document.getElementById("app-screen"),
      };
      const views = {
        edit: document.getElementById("edit-view"),
        run: document.getElementById("run-view"),
        settings: document.getElementById("settings-view"),
        logs: document.getElementById("log-manager-modal"),
        manageRoutines: document.getElementById("manage-routines-view"),
        routineEditor: document.getElementById("routine-editor-modal"),
      };
      const inputs = {
        routine: document.getElementById("routine-input"),
        logs: document.getElementById("logs-input"),
      };
      const display = {
        taskCard: document.getElementById("task-card"),
        taskText: document.getElementById("task-text"),
        taskIcon: document.getElementById("task-icon"),
        nextTask: document.getElementById("next-task-text"),
        timerBox: document.getElementById("timer-display"),
        timerVal: document.getElementById("timer-val"),
        waitOverlay: document.getElementById("wait-overlay"),
        waitTarget: document.getElementById("wait-target-time"),
        waitCount: document.getElementById("wait-countdown"),
        globalProgress: document.getElementById("global-progress"),
        syncStatus: document.getElementById("sync-status"),
        syncIndicator: document.getElementById("sync-indicator"),
        userId: document.getElementById("user-id-display"),
        subRoutineIndicator: document.getElementById("sub-routine-indicator"),
        subRoutineParentTitle: document.getElementById(
          "sub-routine-parent-title",
        ),
        subRoutineCurrent: document.getElementById("sub-routine-current"),
        subRoutineTotal: document.getElementById("sub-routine-total"),
      };
      const toggles = {
        theme: document.getElementById("theme-toggle"),
        autoAdvance: document.getElementById("auto-advance-toggle"),
        wakeLock: document.getElementById("wake-lock-toggle"),
      };

      // GLOBAL STATE
      let appState = {
        // Multiple Routines support
        routines: [], // Array of {id, name, content, isDefault, conditions}
        activeRoutineId: null, // Currently active routine ID

        // Legacy field for backward compatibility (will be migrated)
        rawRoutine: "",

        currentTaskIndex: 0,
        currentSubRoutineIndex: 0,
        tasks: [],
        history: {}, // Keyed by YYYY-MM-DD
        settings: {
          darkMode: true,
          autoAdvance: false,
          wakeLock: true,
          prayerLocation: {
            latitude: null,
            longitude: null,
          },
        },
        prayerTimes: null, // Cached prayer times for today
        prayerTimesDate: null, // Date for which prayer times are cached
        isPaused: false,
      };

      // Editing state (not persisted)
      let editingRoutineId = null;
      let app, auth, db, user;
      let isSaving = false; // Flag to prevent sync overwrites during save
      let isOnline = navigator.onLine; // Track network status
      let timerInterval, alarmLoopInterval, wakeLock;
      const alarmAudio = new Audio(ALARM_FILE);
      alarmAudio.loop = true;

      // --- INIT ---
      function init() {
        if (
          "serviceWorker" in navigator &&
          (location.protocol === "http:" || location.protocol === "https:")
        ) {
          navigator.serviceWorker.register("sw.js").catch(console.error);
        }

        // Network status monitoring
        window.addEventListener("online", () => {
          isOnline = true;
          showSyncStatus("Online", "emerald");
        });
        window.addEventListener("offline", () => {
          isOnline = false;
          showSyncStatus("Offline", "yellow");
        });

        // Check/Request Notification permission on load if already granted, otherwise wait for interaction
        if ("Notification" in window && Notification.permission === "granted") {
          // Ready
        }

        const savedSettings = localStorage.getItem("rr_settings");
        if (savedSettings)
          appState.settings = {
            ...appState.settings,
            ...JSON.parse(savedSettings),
          };
        applySettings();
        loadPrayerLocation();
        // Fetch prayer times if location is set
        if (
          appState.settings.prayerLocation.latitude &&
          appState.settings.prayerLocation.longitude
        ) {
          fetchPrayerTimes();
        }

        // Initialize Firebase with hardcoded config
        initFirebase(FIREBASE_CONFIG);
        setupEventListeners();
      }

      function applySettings() {
        if (appState.settings.darkMode) {
          document.body.classList.remove("light-mode");
          document.getElementById("theme-color-meta").content = "#0f172a";
        } else {
          document.body.classList.add("light-mode");
          document.getElementById("theme-color-meta").content = "#f1f5f9";
        }
        toggles.theme.checked = appState.settings.darkMode;
        toggles.autoAdvance.checked = appState.settings.autoAdvance;
        toggles.wakeLock.checked = appState.settings.wakeLock !== false;

        if (appState.settings.wakeLock !== false) {
          requestWakeLock();
        } else {
          releaseWakeLock();
        }
      }

      // --- PRAYER TIME FUNCTIONALITY ---
      const VALID_PRAYER_NAMES = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];

      function loadPrayerLocation() {
        const saved = localStorage.getItem("rr_prayer_location");
        if (saved) {
          try {
            const location = JSON.parse(saved);
            appState.settings.prayerLocation = {
              latitude: location.latitude || null,
              longitude: location.longitude || null,
            };
            // Update UI if elements exist
            const latInput = document.getElementById("prayer-latitude");
            const lonInput = document.getElementById("prayer-longitude");
            if (latInput)
              latInput.value = appState.settings.prayerLocation.latitude || "";
            if (lonInput)
              lonInput.value = appState.settings.prayerLocation.longitude || "";
          } catch (e) {
            console.error("Failed to load prayer location:", e);
          }
        }
      }

      function savePrayerLocation() {
        // Keep the legacy/backup "rr_prayer_location" as requested
        localStorage.setItem(
          "rr_prayer_location",
          JSON.stringify(appState.settings.prayerLocation),
        );
        // Sync to cloud (this also updates "rr_settings" in localStorage via saveStateToCloud)
        saveStateToCloud();
      }

      async function getDailyPrayerTimes() {
        const lat = appState.settings.prayerLocation.latitude;
        const lon = appState.settings.prayerLocation.longitude;

        if (!lat || !lon) {
          console.warn("Prayer location not set");
          return null;
        }

        const today = new Date();
        const dateString = `${String(today.getDate()).padStart(
          2,
          "0",
        )}-${String(today.getMonth() + 1).padStart(
          2,
          "0",
        )}-${today.getFullYear()}`;

        const url = new URL(`https://api.aladhan.com/v1/timings/${dateString}`);
        const params = {
          latitude: String(lat),
          longitude: String(lon),
          method: "1",
          shafaq: "general",
          tune: "0,0,0,0,0,0,0,-4,0",
          calendarMethod: "UAQ",
        };
        url.search = new URLSearchParams(params).toString();

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 20000);

          const response = await fetch(url, {
            headers: { Accept: "application/json" },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (!response.ok) throw new Error(`Error: ${response.status}`);
          const json = await response.json();
          return json.data;
        } catch (error) {
          if (error.name === "AbortError") {
            console.error(
              "Prayer time request timed out (took longer than 20s)",
            );
          } else {
            console.error("Fetch failed:", error.message);
          }
          return null;
        }
      }

      async function fetchPrayerTimes() {
        const today = new Date().toDateString();
        // Use in-memory cached times if available for today
        if (appState.prayerTimes && appState.prayerTimesDate === today) {
          return appState.prayerTimes;
        }

        // Try to fetch new data
        const data = await getDailyPrayerTimes();
        if (data && data.timings) {
          appState.prayerTimes = data.timings;
          appState.prayerTimesDate = today;
          // Cache to localStorage for offline use
          localStorage.setItem(
            "rr_prayer_times_cache",
            JSON.stringify({ date: today, timings: data.timings }),
          );
          return appState.prayerTimes;
        }

        // If fetch failed, try localStorage cache
        const cached = localStorage.getItem("rr_prayer_times_cache");
        if (cached) {
          try {
            const cachedData = JSON.parse(cached);
            if (cachedData.date === today && cachedData.timings) {
              console.log("Using cached prayer times from localStorage");
              appState.prayerTimes = cachedData.timings;
              appState.prayerTimesDate = today;
              return appState.prayerTimes;
            }
          } catch (e) {
            console.error("Failed to parse cached prayer times:", e);
          }
        }

        return null;
      }

      function getPrayerTime(prayerName) {
        if (!appState.prayerTimes) return null;

        // Normalize prayer name (handle case variations)
        const normalized =
          prayerName.charAt(0).toUpperCase() + prayerName.slice(1);
        const validName = VALID_PRAYER_NAMES.find(
          (name) => name.toLowerCase() === normalized.toLowerCase(),
        );

        if (!validName) {
          console.warn(
            `Invalid prayer name: ${prayerName}. Valid names: ${VALID_PRAYER_NAMES.join(
              ", ",
            )}`,
          );
          return null;
        }

        // API returns times like "05:30 (PKT)" - extract just the time
        const timeStr = appState.prayerTimes[validName];
        if (!timeStr) return null;

        const match = timeStr.match(/(\d{1,2}):(\d{2})/);
        if (match) {
          return `${match[1]}:${match[2]}`;
        }
        return null;
      }

      function validatePrayerName(prayerName) {
        const normalized =
          prayerName.charAt(0).toUpperCase() + prayerName.slice(1);
        return VALID_PRAYER_NAMES.some(
          (name) => name.toLowerCase() === normalized.toLowerCase(),
        );
      }

      function initFirebase(config) {
        try {
          app = initializeApp(config);
          auth = getAuth(app);

          // Use the new cache API for offline persistence
          db = initializeFirestore(app, {
            localCache: persistentLocalCache(),
          });

          onAuthStateChanged(auth, (u) => {
            if (u) {
              user = u;
              document.getElementById("user-avatar").src = u.photoURL;
              display.userId.innerText = u.uid.substring(0, 8) + "...";
              showScreen("app");
              initFirestoreListener();
              requestWakeLock();
            } else {
              showScreen("login");
            }
          });
        } catch (e) {
          console.error("Firebase init error", e);
          alert(
            "Error initializing Firebase. Please check your configuration in index.html",
          );
        }
      }

      function initFirestoreListener() {
        if (!user) return;
        const docRef = doc(db, "users", user.uid);
        showSyncStatus("Connecting...", "yellow");

        onSnapshot(
          docRef,
          (docSnap) => {
            showSyncStatus("Synced", "emerald");
            if (isSaving) return; // Ignore sync while saving locally
            if (docSnap.exists()) {
              const data = docSnap.data();

              // Support for multiple routines
              if (data.routines && data.routines.length > 0) {
                appState.routines = data.routines;
                appState.activeRoutineId =
                  data.activeRoutineId || selectRoutineForToday();
              } else if (data.rawRoutine) {
                // Migrate from old format
                migrateToMultipleRoutines(data.rawRoutine);
              }

              // Set rawRoutine from active routine for backward compatibility
              const activeRoutine = getActiveRoutine();
              appState.rawRoutine = activeRoutine ? activeRoutine.content : "";

              appState.currentTaskIndex = data.currentTaskIndex || 0;
              appState.currentSubRoutineIndex =
                data.currentSubRoutineIndex || 0;
              appState.history = data.history || {};

              // Sync Settings
              if (data.settings) {
                appState.settings = { ...appState.settings, ...data.settings };
                applySettings();
                // Update local cache for next offline boot
                localStorage.setItem(
                  "rr_settings",
                  JSON.stringify(appState.settings),
                );
              }

              if (document.activeElement !== inputs.routine)
                inputs.routine.value = appState.rawRoutine;

              updateActiveRoutineDisplay();
              parseAndRender();
            } else if (appState.routines.length === 0) {
              // No data, create default routine
              migrateToMultipleRoutines("");
              views.edit.classList.remove("translate-x-full");
            }
          },
          (error) => {
            showSyncStatus("Error!", "red");
          },
        );
      }

      async function saveStateToCloud() {
        if (!user) return;
        isSaving = true;
        showSyncStatus("Saving...", "blue");
        try {
          await setDoc(
            doc(db, "users", user.uid),
            {
              routines: appState.routines,
              activeRoutineId: appState.activeRoutineId,
              rawRoutine: appState.rawRoutine, // Keep for backward compat
              currentTaskIndex: appState.currentTaskIndex,
              currentSubRoutineIndex: appState.currentSubRoutineIndex,
              history: appState.history,
              settings: appState.settings,
              lastUpdated: Date.now(),
            },
            { merge: true },
          );
          // Also update local cache for offline boot
          localStorage.setItem(
            "rr_settings",
            JSON.stringify(appState.settings),
          );
          showSyncStatus("Synced", "emerald");
        } catch (e) {
          showSyncStatus("Error!", "red");
        } finally {
          isSaving = false;
        }
      }

      // --- MULTIPLE ROUTINES MANAGEMENT ---
      function generateUUID() {
        return (
          "routine-" +
          Date.now() +
          "-" +
          Math.random().toString(36).substring(2, 11)
        );
      }

      function getActiveRoutine() {
        return (
          appState.routines.find((r) => r.id === appState.activeRoutineId) ||
          appState.routines[0]
        );
      }

      function migrateToMultipleRoutines(rawRoutine) {
        const defaultRoutine = {
          id: generateUUID(),
          name: "Daily Routine",
          content: rawRoutine || "",
          isDefault: true,
          conditions: null,
        };
        appState.routines = [defaultRoutine];
        appState.activeRoutineId = defaultRoutine.id;
        saveStateToCloud();
      }

      function matchesCondition(conditions, date) {
        if (!conditions) return false;

        const dayOfWeek = date.getDay();
        const dateOfMonth = date.getDate();

        switch (conditions.type) {
          case "weekday":
            return (
              conditions.weekdays && conditions.weekdays.includes(dayOfWeek)
            );

          case "date":
            return conditions.dates && conditions.dates.includes(dateOfMonth);

          case "pattern":
            return matchesPattern(conditions.pattern, date);

          case "manual":
            return false; // Never auto-select manual routines

          default:
            return false;
        }
      }

      function matchesPattern(pattern, date) {
        if (!pattern) return false;

        const [position, dayName] = pattern.split("-");
        const dayMap = {
          sunday: 0,
          monday: 1,
          tuesday: 2,
          wednesday: 3,
          thursday: 4,
          friday: 5,
          saturday: 6,
        };
        const targetDay = dayMap[dayName];

        if (targetDay === undefined) return false;
        if (date.getDay() !== targetDay) return false;

        const dateOfMonth = date.getDate();

        if (position === "first") {
          return dateOfMonth <= 7;
        } else if (position === "last") {
          // Check if this is the last occurrence of this day in the month
          const nextWeek = new Date(date);
          nextWeek.setDate(dateOfMonth + 7);
          return nextWeek.getMonth() !== date.getMonth();
        }

        return false;
      }

      function selectRoutineForToday() {
        const today = new Date();

        // First, check for routines with matching conditions
        for (const routine of appState.routines) {
          if (
            routine.conditions &&
            matchesCondition(routine.conditions, today)
          ) {
            return routine.id;
          }
        }

        // Fall back to default routine
        const defaultRoutine = appState.routines.find((r) => r.isDefault);
        return defaultRoutine
          ? defaultRoutine.id
          : appState.routines[0]?.id || null;
      }

      function updateActiveRoutineDisplay() {
        const activeRoutine = getActiveRoutine();
        const nameEl = document.getElementById("active-routine-name");
        if (nameEl && activeRoutine) {
          nameEl.innerText = activeRoutine.name;
        }
      }

      function renderRoutineList() {
        const listEl = document.getElementById("routine-list");
        if (!listEl) return;

        // Helper to escape HTML special chars (XSS prevention)
        const escapeHtml = (str) =>
          String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");

        listEl.innerHTML = "";

        appState.routines.forEach((routine) => {
          const isActive = routine.id === appState.activeRoutineId;
          const conditionText = getConditionDisplayText(routine);

          const item = document.createElement("div");
          item.className = `p-4 rounded-xl border ${
            isActive
              ? "border-emerald-500 bg-emerald-500/10"
              : "border-custom bg-card-custom"
          } cursor-pointer hover:border-blue-500 transition`;
          item.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  ${
                    routine.isDefault
                      ? '<i class="fas fa-star text-yellow-500 text-xs"></i>'
                      : ""
                  }
                  <span class="font-bold">${escapeHtml(routine.name)}</span>
                  ${
                    isActive
                      ? '<span class="text-xs bg-emerald-500 text-white px-2 py-0.5 rounded">Active</span>'
                      : ""
                  }
                </div>
                <p class="text-xs text-muted-custom mt-1">${escapeHtml(conditionText)}</p>
              </div>
              <div class="flex gap-2">
                <button class="edit-routine-item text-blue-400 hover:text-blue-300 p-2" data-id="${escapeHtml(
                  routine.id,
                )}">
                  <i class="fas fa-pen text-sm"></i>
                </button>
                <button class="activate-routine-item text-emerald-400 hover:text-emerald-300 p-2 ${
                  isActive ? "hidden" : ""
                }" data-id="${escapeHtml(routine.id)}">
                  <i class="fas fa-play text-sm"></i>
                </button>
              </div>
            </div>
          `;

          listEl.appendChild(item);
        });

        // Add click handlers
        listEl.querySelectorAll(".edit-routine-item").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            openRoutineEditor(btn.dataset.id);
          });
        });

        listEl.querySelectorAll(".activate-routine-item").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            switchToRoutine(btn.dataset.id);
          });
        });
      }

      function getConditionDisplayText(routine) {
        if (routine.isDefault && !routine.conditions) return "Default";
        if (!routine.conditions) return "No schedule";

        const c = routine.conditions;
        switch (c.type) {
          case "weekday":
            const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            return c.weekdays.map((d) => days[d]).join(", ");
          case "date":
            return "Days: " + c.dates.join(", ");
          case "pattern":
            return c.pattern
              .replace("-", " ")
              .replace(/\b\w/g, (l) => l.toUpperCase());
          case "manual":
            return "Manual only";
          default:
            return "Default";
        }
      }

      function openRoutineEditor(routineId = null) {
        editingRoutineId = routineId;
        const modal = document.getElementById("routine-editor-modal");
        const titleEl = document.getElementById("routine-editor-title");
        const nameInput = document.getElementById("routine-name-input");
        const contentInput = document.getElementById("routine-content-input");
        const conditionType = document.getElementById("routine-condition-type");
        const isDefaultCheck = document.getElementById("routine-is-default");
        const deleteBtn = document.getElementById("delete-routine-btn");

        // Reset form
        resetConditionSelectors();

        if (routineId) {
          // Editing existing routine
          const routine = appState.routines.find((r) => r.id === routineId);
          if (!routine) return;

          titleEl.innerText = "Edit Routine";
          nameInput.value = routine.name;
          contentInput.value = routine.content;
          isDefaultCheck.checked = routine.isDefault;

          if (routine.conditions) {
            conditionType.value = routine.conditions.type;
            showConditionSelector(routine.conditions.type);
            populateConditionValues(routine.conditions);
          } else {
            conditionType.value = "default";
          }

          deleteBtn.classList.remove("hidden");
        } else {
          // New routine
          titleEl.innerText = "New Routine";
          nameInput.value = "";
          contentInput.value = "";
          conditionType.value = "default";
          isDefaultCheck.checked = false;
          deleteBtn.classList.add("hidden");
        }

        modal.classList.remove("hidden");
      }

      function closeRoutineEditor() {
        document.getElementById("routine-editor-modal").classList.add("hidden");
        editingRoutineId = null;
      }

      function resetConditionSelectors() {
        document.getElementById("weekday-selector").classList.add("hidden");
        document.getElementById("date-selector").classList.add("hidden");
        document.getElementById("pattern-selector").classList.add("hidden");

        // Reset weekday buttons
        document.querySelectorAll(".weekday-btn").forEach((btn) => {
          btn.classList.remove("bg-blue-600");
          btn.classList.add("bg-slate-700");
        });

        document.getElementById("routine-dates-input").value = "";
        document.getElementById("routine-pattern-input").value = "first-friday";
      }

      function showConditionSelector(type) {
        resetConditionSelectors();
        if (type === "weekday") {
          document
            .getElementById("weekday-selector")
            .classList.remove("hidden");
        } else if (type === "date") {
          document.getElementById("date-selector").classList.remove("hidden");
        } else if (type === "pattern") {
          document
            .getElementById("pattern-selector")
            .classList.remove("hidden");
        }
      }

      function populateConditionValues(conditions) {
        if (conditions.type === "weekday" && conditions.weekdays) {
          conditions.weekdays.forEach((day) => {
            const btn = document.querySelector(
              `.weekday-btn[data-day="${day}"]`,
            );
            if (btn) {
              btn.classList.remove("bg-slate-700");
              btn.classList.add("bg-blue-600");
            }
          });
        } else if (conditions.type === "date" && conditions.dates) {
          document.getElementById("routine-dates-input").value =
            conditions.dates.join(", ");
        } else if (conditions.type === "pattern" && conditions.pattern) {
          document.getElementById("routine-pattern-input").value =
            conditions.pattern;
        }
      }

      function saveRoutineFromEditor() {
        const nameInput = document.getElementById("routine-name-input");
        const contentInput = document.getElementById("routine-content-input");
        const conditionType = document.getElementById("routine-condition-type");
        const isDefaultCheck = document.getElementById("routine-is-default");

        const name = nameInput.value.trim() || "Untitled Routine";
        const content = contentInput.value;
        const isDefault = isDefaultCheck.checked;

        // Validate prayer names in routine
        const prayerMatches = content.matchAll(/\[(@|=>)Prayer:(\w+)\]/gi);
        const invalidPrayers = [];
        for (const match of prayerMatches) {
          const prayerName = match[2];
          if (!validatePrayerName(prayerName)) {
            invalidPrayers.push(prayerName);
          }
        }

        if (invalidPrayers.length > 0) {
          const uniqueInvalid = [...new Set(invalidPrayers)];
          const warning = `Invalid prayer name(s): ${uniqueInvalid.join(
            ", ",
          )}\n\nValid prayer names: ${VALID_PRAYER_NAMES.join(
            ", ",
          )}\n\nDo you want to save anyway?`;
          if (!confirm(warning)) {
            return; // User cancelled, don't save
          }
        }

        // Build conditions object
        let conditions = null;
        const type = conditionType.value;

        if (type === "weekday") {
          const selectedDays = [];
          document
            .querySelectorAll(".weekday-btn.bg-blue-600")
            .forEach((btn) => {
              selectedDays.push(parseInt(btn.dataset.day));
            });
          if (selectedDays.length > 0) {
            conditions = { type: "weekday", weekdays: selectedDays };
          }
        } else if (type === "date") {
          const datesStr = document.getElementById("routine-dates-input").value;
          const dates = datesStr
            .split(",")
            .map((d) => parseInt(d.trim()))
            .filter((d) => !isNaN(d) && d >= 1 && d <= 31);
          if (dates.length > 0) {
            conditions = { type: "date", dates };
          }
        } else if (type === "pattern") {
          const pattern = document.getElementById(
            "routine-pattern-input",
          ).value;
          conditions = { type: "pattern", pattern };
        } else if (type === "manual") {
          conditions = { type: "manual" };
        }

        if (editingRoutineId) {
          // Update existing routine
          const idx = appState.routines.findIndex(
            (r) => r.id === editingRoutineId,
          );
          if (idx >= 0) {
            appState.routines[idx].name = name;
            appState.routines[idx].content = content;
            appState.routines[idx].conditions = conditions;

            if (isDefault) {
              // Unset other defaults
              appState.routines.forEach((r) => (r.isDefault = false));
              appState.routines[idx].isDefault = true;
            }

            // Update rawRoutine if this is active
            if (editingRoutineId === appState.activeRoutineId) {
              appState.rawRoutine = content;
              inputs.routine.value = content;
            }
          }
        } else {
          // Create new routine
          const newRoutine = {
            id: generateUUID(),
            name,
            content,
            isDefault: isDefault || appState.routines.length === 0,
            conditions,
          };

          if (newRoutine.isDefault) {
            appState.routines.forEach((r) => (r.isDefault = false));
          }

          appState.routines.push(newRoutine);
        }

        closeRoutineEditor();
        renderRoutineList();
        updateActiveRoutineDisplay();
        saveStateToCloud();
      }

      function deleteRoutine(routineId) {
        if (appState.routines.length <= 1) {
          alert("Cannot delete the last routine.");
          return;
        }

        const idx = appState.routines.findIndex((r) => r.id === routineId);
        if (idx >= 0) {
          const wasActive = routineId === appState.activeRoutineId;
          const wasDefault = appState.routines[idx].isDefault;

          appState.routines.splice(idx, 1);

          // If deleted was default, make first one default
          if (wasDefault && appState.routines.length > 0) {
            appState.routines[0].isDefault = true;
          }

          // If deleted was active, switch to another
          if (wasActive) {
            appState.activeRoutineId = selectRoutineForToday();
            const active = getActiveRoutine();
            appState.rawRoutine = active ? active.content : "";
            inputs.routine.value = appState.rawRoutine;
            appState.currentTaskIndex = 0;
            appState.currentSubRoutineIndex = 0;
            parseAndRender();
          }

          closeRoutineEditor();
          renderRoutineList();
          updateActiveRoutineDisplay();
          saveStateToCloud();
        }
      }

      function switchToRoutine(routineId) {
        const routine = appState.routines.find((r) => r.id === routineId);
        if (!routine) return;

        appState.activeRoutineId = routineId;
        appState.rawRoutine = routine.content;
        appState.currentTaskIndex = 0;
        appState.currentSubRoutineIndex = 0;

        inputs.routine.value = appState.rawRoutine;

        renderRoutineList();
        updateActiveRoutineDisplay();
        parseAndRender();
        saveStateToCloud();

        // Close manage routines view
        document
          .getElementById("manage-routines-view")
          .classList.add("translate-x-full");
        views.settings.classList.add("translate-x-full");
      }

      function showSyncStatus(msg, color) {
        display.syncStatus.innerText =
          msg === "Synced"
            ? `Synced ${new Date().toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              })}`
            : msg;
        display.syncIndicator.className = `w-2 h-2 rounded-full mr-2 transition-colors duration-300 ${
          color === "emerald"
            ? "bg-emerald-500"
            : color === "yellow"
              ? "bg-yellow-500"
              : color === "red"
                ? "bg-red-500"
                : "bg-blue-500"
        }`;
      }

      // --- LOGGING ---
      function logTask(status) {
        const task = appState.tasks[appState.currentTaskIndex];
        if (!task) return;

        // Determine which task text to log (sub-routine item or main task)
        let logText = task.text;
        if (task.isSubRoutineParent && task.subRoutines.length > 0) {
          const subTask = task.subRoutines[appState.currentSubRoutineIndex];
          if (subTask) {
            logText = `${task.text} > ${subTask.text}`;
          }
        }

        const today = new Date().toISOString().split("T")[0];
        if (!appState.history[today]) appState.history[today] = [];

        appState.history[today].push({
          time: new Date().toLocaleTimeString(),
          task: logText,
          status: status,
        });
        // State is saved after this call in actions
      }

      // --- LOGIC & RENDERER ---
      // --- CONDITIONALS ---
      function checkCondition(cond) {
        const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        const today = days[new Date().getDay()];
        if (cond.startsWith("!")) {
          return today !== cond.substring(1);
        }
        return today === cond;
      }

      function parseRoutine(text) {
        const lines = text.split("\n");

        // Helper function to parse a single line into a task object
        function parseLine(line, index) {
          if (line.trim() === "") return null;
          let rawLine = line.trim();

          // Check if this is a sub-routine item (starts with "- ")
          const isSubRoutineItem = rawLine.startsWith("- ");
          if (isSubRoutineItem) {
            rawLine = rawLine.substring(2).trim(); // Remove "- " prefix
          }

          // 1. Logic Pre-processor (IF/ELSE)
          if (rawLine.startsWith("IF:")) {
            const firstSeparator = rawLine.indexOf("::");
            if (firstSeparator !== -1) {
              const condition = rawLine.substring(3, firstSeparator); // Remove "IF:"
              const remainder = rawLine.substring(firstSeparator + 2);

              let mainTask = remainder;
              let elsePart = null;

              if (remainder.includes("| ELSE::")) {
                const elseSplit = remainder.split("| ELSE::");
                mainTask = elseSplit[0];
                elsePart = elseSplit[1];
              }

              if (checkCondition(condition)) {
                rawLine = mainTask;
              } else if (elsePart) {
                rawLine = elsePart;
              } else {
                return null; // Skip this task
              }
            }
          }

          let type = "standard",
            meta = null,
            cleanText = rawLine;

          // Check if this is a sub-routine parent (ends with ":")
          const isSubRoutineParent =
            cleanText.endsWith(":") && !isSubRoutineItem;
          if (isSubRoutineParent) {
            cleanText = cleanText.slice(0, -1).trim(); // Remove trailing ":"
          }

          // 2. Bracket Syntax Parser
          // [@Prayer:Name] - Prayer Gate (check before regular gate)
          const prayerGateMatch = rawLine.match(/\[@Prayer:(\w+)\]/i);
          if (prayerGateMatch) {
            const prayerName = prayerGateMatch[1];
            if (!validatePrayerName(prayerName)) {
              console.warn(
                `Invalid prayer name: ${prayerName}. Valid names: ${VALID_PRAYER_NAMES.join(
                  ", ",
                )}`,
              );
            }
            type = "prayerGate";
            meta = prayerName;
            cleanText = cleanText.replace(prayerGateMatch[0], "").trim();
          }

          // [=>Prayer:Name] - Prayer Till (check before regular till)
          const prayerTillMatch = rawLine.match(/\[=>Prayer:(\w+)\]/i);
          if (prayerTillMatch) {
            const prayerName = prayerTillMatch[1];
            if (!validatePrayerName(prayerName)) {
              console.warn(
                `Invalid prayer name: ${prayerName}. Valid names: ${VALID_PRAYER_NAMES.join(
                  ", ",
                )}`,
              );
            }
            type = "prayerTill";
            meta = prayerName;
            cleanText = cleanText.replace(prayerTillMatch[0], "").trim();
          }

          // [@HH:MM] - Gate
          const gateMatch = rawLine.match(/\[@(\d{1,2}:\d{2})\]/);
          if (gateMatch && type === "standard") {
            type = "gate";
            meta = gateMatch[1];
            cleanText = cleanText.replace(gateMatch[0], "").trim();
          }

          // [=>HH:MM] - Till
          const tillMatch = rawLine.match(/\[=>(\d{1,2}:\d{2})\]/);
          if (tillMatch && type === "standard") {
            type = "till";
            meta = tillMatch[1];
            cleanText = cleanText.replace(tillMatch[0], "").trim();
          }

          // [Xm] - Timer
          const durationMatch = rawLine.match(/\[(\d+)m\]/i);
          if (durationMatch) {
            type = "timer";
            meta = parseInt(durationMatch[1]) * 60;
            cleanText = cleanText.replace(durationMatch[0], "").trim();
          }

          // [http...] - Link
          const linkMatch = rawLine.match(/\[(https?:\/\/[^\]]+)\]/);
          let link = null;
          if (linkMatch) {
            link = linkMatch[1];
            cleanText = cleanText.replace(linkMatch[0], "").trim();
          }

          const highMatch = rawLine.match(/==(.*?)==/);
          let isHigh = false;
          if (highMatch) {
            isHigh = true;
            cleanText = cleanText.replace(/==/g, "").trim();
          }

          const emojiMatch = cleanText.match(
            /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u,
          );
          const icon = emojiMatch ? emojiMatch[0] : "âœ…";
          // Final cleanup of cleanText to remove any # comments if user adds them
          cleanText = cleanText.split("#")[0].trim();
          const displayText = cleanText.replace(icon, "").trim();

          return {
            id: index,
            raw: line,
            text: displayText,
            icon,
            type,
            meta,
            link,
            isHigh,
            isSubRoutineParent,
            isSubRoutineItem,
            subRoutines: [], // Will be populated for parents
          };
        }

        // First pass: parse all lines
        const parsedLines = lines
          .map((line, index) => parseLine(line, index))
          .filter((t) => t !== null);

        // Second pass: group sub-routines under their parent
        const result = [];
        for (let i = 0; i < parsedLines.length; i++) {
          const task = parsedLines[i];

          if (task.isSubRoutineItem) {
            // This is a sub-routine item, attach to the last parent in result
            if (
              result.length > 0 &&
              result[result.length - 1].isSubRoutineParent
            ) {
              result[result.length - 1].subRoutines.push(task);
            } else {
              // No parent found, treat as regular task
              task.isSubRoutineItem = false;
              result.push(task);
            }
          } else {
            result.push(task);
          }
        }

        return result;
      }

      function parseAndRender() {
        appState.tasks = parseRoutine(appState.rawRoutine);
        setControlsState(true);
        stopAlarm();
        clearInterval(timerInterval);

        // Clamp currentTaskIndex to valid bounds
        if (appState.currentTaskIndex < 0) appState.currentTaskIndex = 0;

        if (appState.currentTaskIndex >= appState.tasks.length) {
          document
            .getElementById("active-task-container")
            .classList.add("hidden");
          document.getElementById("all-done-state").classList.remove("hidden");
          document.getElementById("empty-state").classList.add("hidden");
          display.subRoutineIndicator.classList.add("hidden");
          return;
        }
        if (appState.tasks.length === 0) {
          document.getElementById("empty-state").classList.remove("hidden");
          document
            .getElementById("active-task-container")
            .classList.add("hidden");
          display.subRoutineIndicator.classList.add("hidden");
          return;
        }

        document.getElementById("empty-state").classList.add("hidden");
        document.getElementById("all-done-state").classList.add("hidden");
        document
          .getElementById("active-task-container")
          .classList.remove("hidden");

        const task = appState.tasks[appState.currentTaskIndex];
        const nextTask = appState.tasks[appState.currentTaskIndex + 1];

        // Determine what to display based on sub-routine state
        let displayTask = task;
        let isInSubRoutine = false;

        if (task.isSubRoutineParent && task.subRoutines.length > 0) {
          // We're in a sub-routine parent, show the current sub-routine item
          isInSubRoutine = true;

          // Validate sub-routine index
          if (appState.currentSubRoutineIndex >= task.subRoutines.length) {
            appState.currentSubRoutineIndex = 0;
          }

          displayTask = task.subRoutines[appState.currentSubRoutineIndex];

          // Show consolidated sub-routine indicator at bottom: JOURNAL [1/3]
          display.subRoutineParentTitle.innerText = task.text;
          display.subRoutineIndicator.classList.remove("hidden");
          display.subRoutineCurrent.innerText =
            appState.currentSubRoutineIndex + 1;
          display.subRoutineTotal.innerText = task.subRoutines.length;
        } else {
          // Regular task, hide sub-routine indicator
          display.subRoutineIndicator.classList.add("hidden");
        }

        display.taskText.innerText = displayTask.text || "Untitled";
        display.taskIcon.innerText = displayTask.icon;

        // Link Button
        const linkBtn = document.getElementById("task-link-btn");
        if (displayTask.link) {
          linkBtn.href = displayTask.link;
          linkBtn.classList.remove("hidden");
        } else {
          linkBtn.classList.add("hidden");
          linkBtn.href = "#";
        }

        // Up Next Text - compute based on sub-routine state
        let nextTaskText = "Finish Line";
        if (isInSubRoutine) {
          // Check if there are more sub-routines
          if (appState.currentSubRoutineIndex < task.subRoutines.length - 1) {
            nextTaskText =
              task.subRoutines[appState.currentSubRoutineIndex + 1].text;
          } else {
            // Sub-routines done, next is the main task after parent
            nextTaskText = nextTask ? nextTask.text : "Finish Line";
          }
        } else {
          nextTaskText = nextTask ? nextTask.text : "Finish Line";
        }
        display.nextTask.innerText = nextTaskText;

        if (displayTask.isHigh) display.taskCard.classList.add("priority-glow");
        else display.taskCard.classList.remove("priority-glow");

        display.globalProgress.style.width = `${
          (appState.currentTaskIndex / appState.tasks.length) * 100
        }%`;

        display.waitOverlay.classList.add("hidden");
        display.timerBox.classList.add("hidden");
        document.getElementById("timer-controls").classList.add("hidden");

        handleTaskLogic(displayTask).catch((err) => {
          console.error("Error handling task logic:", err);
        });
      }

      async function handleTaskLogic(task) {
        if (task.type === "prayerGate") {
          // Fetch prayer times if not cached
          await fetchPrayerTimes();
          const prayerTime = getPrayerTime(task.meta);
          if (prayerTime) {
            const target = getNextOccurrence(prayerTime);
            if (new Date() < target) {
              display.waitOverlay.classList.remove("hidden");
              setControlsState(false);
              display.waitTarget.innerText = `${task.meta}: ${prayerTime}`;
              startTimerCheck(() => {
                const diff = target - new Date();
                if (diff <= 0) {
                  clearInterval(timerInterval);
                  display.waitOverlay.classList.add("hidden");
                  setControlsState(true);
                  sendNotification(
                    "Prayer Time",
                    `It's time for ${task.meta}: ${task.text}`,
                  );
                  triggerCompletion();
                } else {
                  display.waitCount.innerText = formatTime(
                    Math.floor(diff / 1000),
                  );
                }
              });
            }
          } else {
            console.warn(
              `Prayer time not available for ${task.meta}. Please set location in settings.`,
            );
          }
        } else if (task.type === "prayerTill") {
          // Fetch prayer times if not cached
          await fetchPrayerTimes();
          const prayerTime = getPrayerTime(task.meta);
          if (prayerTime) {
            document.getElementById("pause-btn").classList.add("hidden");
            const target = getNextOccurrence(prayerTime);
            const diffSeconds = Math.floor((target - new Date()) / 1000);
            if (diffSeconds > 0) startCountDown(diffSeconds);
            else {
              display.timerVal.innerText = "00:00";
              display.timerBox.classList.remove("hidden");
            }
          } else {
            console.warn(
              `Prayer time not available for ${task.meta}. Please set location in settings.`,
            );
          }
        } else if (task.type === "gate") {
          const target = getNextOccurrence(task.meta);
          if (new Date() < target) {
            display.waitOverlay.classList.remove("hidden");
            setControlsState(false);
            display.waitTarget.innerText = task.meta;
            startTimerCheck(() => {
              const diff = target - new Date();
              if (diff <= 0) {
                clearInterval(timerInterval);
                display.waitOverlay.classList.add("hidden");
                setControlsState(true);
                sendNotification("Task Ready", `It's time for: ${task.text}`);
                triggerCompletion();
              } else {
                display.waitCount.innerText = formatTime(
                  Math.floor(diff / 1000),
                );
              }
            });
          }
        } else if (task.type === "timer") {
          appState.isPaused = false;
          updatePauseBtn();
          document.getElementById("pause-btn").classList.remove("hidden");
          startCountDown(task.meta);
        } else if (task.type === "till") {
          document.getElementById("pause-btn").classList.add("hidden");
          const target = getNextOccurrence(task.meta);
          const diffSeconds = Math.floor((target - new Date()) / 1000);
          if (diffSeconds > 0) startCountDown(diffSeconds);
          else {
            display.timerVal.innerText = "00:00";
            display.timerBox.classList.remove("hidden");
          }
        }
      }

      function startCountDown(seconds) {
        display.timerBox.classList.remove("hidden");
        document.getElementById("timer-controls").classList.remove("hidden");
        let remaining = seconds;
        updateTimerDisplay(remaining);
        startTimerCheck(() => {
          remaining--;
          updateTimerDisplay(remaining);
          if (remaining <= 0) {
            clearInterval(timerInterval);
            triggerCompletion();
            sendNotification("Timer Done", "Time is up!");
          }
        });
      }

      function triggerCompletion() {
        if (appState.settings.autoAdvance) {
          logTask("auto-done");
          appState.currentTaskIndex++;
          saveStateToCloud();
          parseAndRender();
        } else {
          startAlarmLoop();
        }
      }

      function startTimerCheck(cb) {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (!appState.isPaused) cb();
        }, 1000);
      }

      function togglePause() {
        appState.isPaused = !appState.isPaused;
        updatePauseBtn();
      }

      function updatePauseBtn() {
        const btn = document.getElementById("pause-btn");
        if (!btn) return;
        if (appState.isPaused) {
          btn.innerHTML = '<i class="fas fa-play"></i>';
          display.timerVal.classList.add("opacity-50");
        } else {
          btn.innerHTML = '<i class="fas fa-pause"></i>';
          display.timerVal.classList.remove("opacity-50");
        }
      }

      function setControlsState(enabled) {
        const doneBtn = document.getElementById("done-btn");
        const skipBtn = document.getElementById("skip-btn");
        // Undo remains enabled as per request

        if (enabled) {
          doneBtn.disabled = false;
          skipBtn.disabled = false;
          doneBtn.classList.remove(
            "opacity-50",
            "cursor-not-allowed",
            "pointer-events-none",
          );
          skipBtn.classList.remove(
            "opacity-50",
            "cursor-not-allowed",
            "pointer-events-none",
          );
        } else {
          doneBtn.disabled = true;
          skipBtn.disabled = true;
          doneBtn.classList.add(
            "opacity-50",
            "cursor-not-allowed",
            "pointer-events-none",
          );
          skipBtn.classList.add(
            "opacity-50",
            "cursor-not-allowed",
            "pointer-events-none",
          );
        }
      }

      function startAlarmLoop() {
        alarmAudio.play().catch((e) => console.log("Audio block", e));
      }
      function stopAlarm() {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      }

      // Unlock Audio on First Interaction
      function unlockAudio() {
        alarmAudio
          .play()
          .then(() => {
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
            document.removeEventListener("click", unlockAudio);
            document.removeEventListener("touchstart", unlockAudio);
          })
          .catch((e) => {});
      }
      document.addEventListener("click", unlockAudio);
      document.addEventListener("touchstart", unlockAudio);

      function updateTimerDisplay(s) {
        const h = Math.floor(s / 3600),
          m = Math.floor((s % 3600) / 60),
          sec = s % 60;
        display.timerVal.innerText = `${h > 0 ? h + ":" : ""}${m
          .toString()
          .padStart(2, "0")}:${sec.toString().padStart(2, "0")}`;
      }

      window.adjustTimer = (secs) => {
        stopAlarm();
        const parts = display.timerVal.innerText.split(":");
        let currentSecs =
          parts.length === 3
            ? parseInt(parts[0]) * 3600 +
              parseInt(parts[1]) * 60 +
              parseInt(parts[2])
            : parseInt(parts[0]) * 60 + parseInt(parts[1]);
        startCountDown(currentSecs + secs);
      };

      function getNextOccurrence(timeStr) {
        const [h, m] = timeStr.split(":").map(Number);
        const d = new Date();
        d.setHours(h, m, 0, 0);
        return d;
      }

      function formatTime(s) {
        const h = Math.floor(s / 3600),
          m = Math.floor((s % 3600) / 60),
          sec = s % 60;
        return `${h > 0 ? h + ":" : ""}${m.toString().padStart(2, "0")}:${sec
          .toString()
          .padStart(2, "0")}`;
      }

      // --- NOTIFICATIONS ---
      function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission !== "granted") {
          Notification.requestPermission();
        }
      }

      function sendNotification(title, body) {
        if ("Notification" in window && Notification.permission === "granted") {
          // Try direct Notification API first (works on desktop)
          try {
            new Notification(title, { body, icon: "assets/RR.png" });
          } catch (e) {
            // If direct Notification fails (e.g., on some mobile browsers), use ServiceWorker
            if (navigator.serviceWorker && navigator.serviceWorker.ready) {
              navigator.serviceWorker.ready
                .then((registration) => {
                  registration.showNotification(title, {
                    body: body,
                    icon: "assets/RR.png",
                    vibrate: [200, 100, 200],
                  });
                })
                .catch(() => {}); // Silently fail
            }
          }
        }
      }

      let wakeLockListenerAdded = false;

      async function requestWakeLock() {
        if (!appState.settings.wakeLock) return;
        try {
          wakeLock = await navigator.wakeLock.request("screen");
          // Only add the listener once
          if (!wakeLockListenerAdded) {
            wakeLockListenerAdded = true;
            document.addEventListener("visibilitychange", async () => {
              if (
                document.visibilityState === "visible" &&
                appState.settings.wakeLock &&
                (!wakeLock || wakeLock.released)
              ) {
                try {
                  wakeLock = await navigator.wakeLock.request("screen");
                } catch (err) {
                  // Silently fail on re-acquire
                }
              }
            });
          }
        } catch (err) {
          // Wake Lock not supported or failed - silently ignore
        }
      }

      async function releaseWakeLock() {
        if (wakeLock && typeof wakeLock.release === "function") {
          try {
            await wakeLock.release();
            wakeLock = null;
          } catch (err) {
            console.warn("Wake Lock release failed:", err.message);
          }
        }
      }

      function setupEventListeners() {
        // Helper for safe binding
        const onClick = (id, fn) => {
          const el = document.getElementById(id);
          if (el) {
            el.onclick = (e) => {
              requestNotificationPermission(); // Try requesting on any click
              fn(e);
            };
          }
        };

        // NAV
        onClick("settings-btn", () =>
          views.settings.classList.remove("translate-x-full"),
        );
        onClick("close-settings-btn", () =>
          views.settings.classList.add("translate-x-full"),
        );
        onClick("home-logo-btn", () => {
          views.settings.classList.add("translate-x-full");
          views.edit.classList.add("translate-x-full");
        });

        // EDIT ROUTINE
        onClick("edit-routine-btn", () => {
          views.settings.classList.add("translate-x-full");
          views.edit.classList.remove("translate-x-full");
        });
        onClick("close-edit-btn", () =>
          views.edit.classList.add("translate-x-full"),
        );

        // MANAGE ROUTINES
        onClick("manage-routines-btn", () => {
          views.settings.classList.add("translate-x-full");
          renderRoutineList();
          document
            .getElementById("manage-routines-view")
            .classList.remove("translate-x-full");
        });
        onClick("close-manage-routines-btn", () => {
          document
            .getElementById("manage-routines-view")
            .classList.add("translate-x-full");
        });
        onClick("add-routine-btn", () => {
          openRoutineEditor(null);
        });

        // ROUTINE EDITOR
        onClick("close-routine-editor-btn", closeRoutineEditor);
        onClick("cancel-routine-editor-btn", closeRoutineEditor);
        onClick("save-routine-editor-btn", saveRoutineFromEditor);
        onClick("delete-routine-btn", () => {
          if (
            editingRoutineId &&
            confirm("Are you sure you want to delete this routine?")
          ) {
            deleteRoutine(editingRoutineId);
          }
        });

        // Condition type change
        const conditionTypeSelect = document.getElementById(
          "routine-condition-type",
        );
        if (conditionTypeSelect) {
          conditionTypeSelect.onchange = (e) =>
            showConditionSelector(e.target.value);
        }

        // Weekday buttons toggle
        document.querySelectorAll(".weekday-btn").forEach((btn) => {
          btn.onclick = () => {
            btn.classList.toggle("bg-blue-600");
            btn.classList.toggle("bg-slate-700");
          };
        });

        // LOGS
        onClick("manage-logs-btn", () => {
          inputs.logs.value = JSON.stringify(appState.history, null, 2);
          views.logs.classList.remove("hidden");
        });
        onClick("close-logs-btn", () => views.logs.classList.add("hidden"));
        onClick("copy-logs-btn", () => {
          navigator.clipboard.writeText(inputs.logs.value);
          alert("Logs copied to clipboard!");
        });
        onClick("download-logs-btn", () => {
          const blob = new Blob([inputs.logs.value], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `rr-logs-${new Date().toISOString().split("T")[0]}.json`;
          a.click();
        });
        onClick("save-logs-btn", () => {
          try {
            appState.history = JSON.parse(inputs.logs.value);
            saveStateToCloud();
            views.logs.classList.add("hidden");
          } catch (e) {
            alert("Invalid JSON format. Cannot save.");
          }
        });

        // ACTIONS
        onClick("save-routine-btn", () => {
          appState.rawRoutine = inputs.routine.value;

          // Validate prayer names in routine
          const prayerMatches = appState.rawRoutine.matchAll(
            /\[(@|=>)Prayer:(\w+)\]/gi,
          );
          const invalidPrayers = [];
          for (const match of prayerMatches) {
            const prayerName = match[2];
            if (!validatePrayerName(prayerName)) {
              invalidPrayers.push(prayerName);
            }
          }

          if (invalidPrayers.length > 0) {
            const uniqueInvalid = [...new Set(invalidPrayers)];
            const warning = `Invalid prayer name(s): ${uniqueInvalid.join(
              ", ",
            )}\n\nValid prayer names: ${VALID_PRAYER_NAMES.join(
              ", ",
            )}\n\nDo you want to save anyway?`;
            if (!confirm(warning)) {
              return; // User cancelled, don't save
            }
          }

          // Update active routine content in routines array
          const activeRoutine = getActiveRoutine();
          if (activeRoutine) {
            activeRoutine.content = appState.rawRoutine;
          }

          // Parse new routine to check task count
          const newTasks = parseRoutine(appState.rawRoutine);
          // Only reset to 0 if current index exceeds new task count
          if (appState.currentTaskIndex >= newTasks.length) {
            appState.currentTaskIndex = 0;
            appState.currentSubRoutineIndex = 0;
          }
          saveStateToCloud();
          views.edit.classList.add("translate-x-full");
          parseAndRender();
        });
        onClick("done-btn", () => {
          const task = appState.tasks[appState.currentTaskIndex];

          // Check if we're in a sub-routine
          if (task && task.isSubRoutineParent && task.subRoutines.length > 0) {
            if (appState.currentSubRoutineIndex < task.subRoutines.length - 1) {
              // Move to next sub-routine
              logTask("done");
              appState.currentSubRoutineIndex++;
            } else {
              // All sub-routines done, move to next main task
              logTask("done");
              appState.currentSubRoutineIndex = 0;
              appState.currentTaskIndex++;
            }
          } else {
            // Regular task
            logTask("done");
            appState.currentTaskIndex++;
          }

          saveStateToCloud();
          parseAndRender();
        });
        onClick("skip-btn", () => {
          const task = appState.tasks[appState.currentTaskIndex];

          // Check if we're in a sub-routine
          if (task && task.isSubRoutineParent && task.subRoutines.length > 0) {
            if (appState.currentSubRoutineIndex < task.subRoutines.length - 1) {
              // Skip to next sub-routine
              logTask("skipped");
              appState.currentSubRoutineIndex++;
            } else {
              // All sub-routines done/skipped, move to next main task
              logTask("skipped");
              appState.currentSubRoutineIndex = 0;
              appState.currentTaskIndex++;
            }
          } else {
            // Regular task
            logTask("skipped");
            appState.currentTaskIndex++;
          }

          saveStateToCloud();
          parseAndRender();
        });
        onClick("undo-btn", () => {
          const task = appState.tasks[appState.currentTaskIndex];

          // Check if we're in a sub-routine (not at first sub-routine)
          if (
            task &&
            task.isSubRoutineParent &&
            task.subRoutines.length > 0 &&
            appState.currentSubRoutineIndex > 0
          ) {
            // Go back to previous sub-routine
            appState.currentSubRoutineIndex--;
          } else if (appState.currentTaskIndex > 0) {
            // Go back to previous main task
            appState.currentTaskIndex--;

            // If the previous task was a sub-routine parent, go to its last sub-routine
            const prevTask = appState.tasks[appState.currentTaskIndex];
            if (
              prevTask &&
              prevTask.isSubRoutineParent &&
              prevTask.subRoutines.length > 0
            ) {
              appState.currentSubRoutineIndex = prevTask.subRoutines.length - 1;
            }
          }

          saveStateToCloud();
          parseAndRender();
        });
        onClick("refresh-btn", () => location.reload());
        onClick("reset-day-btn", () => {
          if (confirm("Restart day?")) {
            appState.currentTaskIndex = 0;
            appState.currentSubRoutineIndex = 0;
            saveStateToCloud();
            parseAndRender();
            views.settings.classList.add("translate-x-full");
          }
        });
        onClick("force-start-btn", () => {
          display.waitOverlay.classList.add("hidden");
          setControlsState(true);
          stopAlarm();
          clearInterval(timerInterval);
        });
        onClick("pause-btn", togglePause);

        // SETTINGS
        toggles.theme.addEventListener("change", (e) => {
          appState.settings.darkMode = e.target.checked;
          applySettings();
          saveStateToCloud();
        });
        toggles.autoAdvance.addEventListener("change", (e) => {
          appState.settings.autoAdvance = e.target.checked;
          saveStateToCloud();
        });
        toggles.wakeLock.addEventListener("change", (e) => {
          appState.settings.wakeLock = e.target.checked;
          if (appState.settings.wakeLock) {
            requestWakeLock();
          } else {
            releaseWakeLock();
          }
          saveStateToCloud();
        });

        // PRAYER SETTINGS
        onClick("save-prayer-location-btn", () => {
          const latInput = document.getElementById("prayer-latitude");
          const lonInput = document.getElementById("prayer-longitude");
          const lat = parseFloat(latInput.value);
          const lon = parseFloat(lonInput.value);

          if (isNaN(lat) || isNaN(lon)) {
            alert("Please enter valid latitude and longitude values.");
            return;
          }

          if (lat < -90 || lat > 90) {
            alert("Latitude must be between -90 and 90.");
            return;
          }

          if (lon < -180 || lon > 180) {
            alert("Longitude must be between -180 and 180.");
            return;
          }

          appState.settings.prayerLocation = { latitude: lat, longitude: lon };
          savePrayerLocation();

          // Clear cached prayer times to force refresh
          appState.prayerTimes = null;
          appState.prayerTimesDate = null;

          // Fetch new prayer times
          fetchPrayerTimes()
            .then(() => {
              alert("Prayer location saved! Prayer times updated.");
            })
            .catch(() => {
              alert(
                "Location saved, but failed to fetch prayer times. Please check your internet connection.",
              );
            });
        });

        onClick("get-location-btn", async () => {
          if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
          }

          const btn = document.getElementById("get-location-btn");
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          btn.disabled = true;

          try {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                timeout: 10000,
                enableHighAccuracy: true,
              });
            });

            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            document.getElementById("prayer-latitude").value = lat.toFixed(7);
            document.getElementById("prayer-longitude").value = lon.toFixed(7);

            appState.settings.prayerLocation = {
              latitude: lat,
              longitude: lon,
            };
            savePrayerLocation();

            // Clear cached prayer times
            appState.prayerTimes = null;
            appState.prayerTimesDate = null;

            // Fetch new prayer times
            await fetchPrayerTimes();
            alert("Location obtained from GPS! Prayer times updated.");
          } catch (error) {
            alert(
              "Failed to get location: " +
                (error.message || "Permission denied or timeout"),
            );
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        });

        // AUTH & CONFIG
        // save-config-btn removed

        const disconnectHandler = () => {
          if (confirm("Sign out?")) {
            signOut(auth).then(() => {
              location.reload();
            });
          }
        };
        onClick("login-reset-btn", disconnectHandler); // Kept as "Reset" button for now, acts as logout
        onClick("settings-disconnect-btn", disconnectHandler);

        onClick("google-login-btn", () =>
          signInWithPopup(auth, new GoogleAuthProvider()).catch((e) =>
            alert(e.message),
          ),
        );
        onClick("settings-logout-btn", () => {
          if (confirm("Sign out?")) signOut(auth);
        });

        // QUICK EDIT
        onClick("quick-edit-btn", () => {
          const task = appState.tasks[appState.currentTaskIndex];
          if (task) {
            document.getElementById("quick-edit-input").value = task.raw;
            document
              .getElementById("quick-edit-modal")
              .classList.remove("hidden");
          }
        });
        onClick("cancel-quick-edit", () =>
          document.getElementById("quick-edit-modal").classList.add("hidden"),
        );
        onClick("save-quick-edit", () => {
          const newVal = document.getElementById("quick-edit-input").value;
          const taskID = appState.tasks[appState.currentTaskIndex].id;
          const lines = appState.rawRoutine.split("\n");
          if (lines[taskID] !== undefined) {
            lines[taskID] = newVal;
            appState.rawRoutine = lines.join("\n");
            // Update active routine in routines array
            const activeRoutine = getActiveRoutine();
            if (activeRoutine) {
              activeRoutine.content = appState.rawRoutine;
            }
            saveStateToCloud();
            document.getElementById("quick-edit-modal").classList.add("hidden");
            parseAndRender();
          }
        });
      }

      function showScreen(name) {
        Object.values(screens).forEach((el) => el.classList.add("hidden"));
        screens[name].classList.remove("hidden");
      }
      window.addEventListener("load", init);
    </script>
  </body>
</html>
